[{"filePath":"C:\\Users\\jonat\\Downloads\\redly\\src\\App.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'expanded' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":14,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":14,"endColumn":18,"suggestions":[{"messageId":"removeVar","data":{"varName":"expanded"},"fix":{"range":[657,665],"text":""},"desc":"Remove unused variable 'expanded'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'notificationSettings' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":70,"column":96,"nodeType":"Identifier","messageId":"unusedVar","endLine":70,"endColumn":116,"suggestions":[{"messageId":"removeVar","data":{"varName":"notificationSettings"},"fix":{"range":[2974,2996],"text":""},"desc":"Remove unused variable 'notificationSettings'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'setNotificationSettings' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":70,"column":118,"nodeType":"Identifier","messageId":"unusedVar","endLine":70,"endColumn":141,"suggestions":[{"messageId":"removeVar","data":{"varName":"setNotificationSettings"},"fix":{"range":[2996,3021],"text":""},"desc":"Remove unused variable 'setNotificationSettings'."}]},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n  123 |     window.addEventListener('keydown', handleKeyDown);\n  124 |     if (activeFileId && showTasks) {\n> 125 |       setShowTasks(false);\n      |       ^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  126 |     }\n  127 |     return () => window.removeEventListener('keydown', handleKeyDown);\n  128 |   }, [activeFileId, showTasks, disconnectWorkspace]);","line":125,"column":7,"nodeType":null,"endLine":125,"endColumn":19},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'setActiveFileId'. Either include it or remove the dependency array.","line":128,"column":6,"nodeType":"ArrayExpression","endLine":128,"endColumn":52,"suggestions":[{"desc":"Update the dependencies array to be: [activeFileId, showTasks, disconnectWorkspace, setActiveFileId]","fix":{"range":[5180,5226],"text":"[activeFileId, showTasks, disconnectWorkspace, setActiveFileId]"}}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport { useNotes } from './context/NotesContext';\r\nimport Sidebar from './components/Sidebar';\r\nimport Editor from './components/Editor';\r\nimport HelpModal from './components/HelpModal';\r\nimport GlobalTasks from './components/GlobalTasks';\r\nimport WelcomeScreen from './components/WelcomeScreen';\r\nimport GlobalSearch from './components/GlobalSearch';\r\nimport { Menu, Sun, Moon, Bell } from 'lucide-react';\r\nimport { requestNotificationPermission } from './utils/notificationManager';\r\n\r\nfunction NotificationToggle() {\r\n  const { notificationSettings, setNotificationSettings } = useNotes();\r\n  const [expanded, setExpanded] = useState(false);\r\n\r\n  const handleToggle = async () => {\r\n    if (!notificationSettings.enabled) {\r\n      const granted = await requestNotificationPermission();\r\n      if (!granted) return;\r\n    }\r\n    setNotificationSettings(prev => ({ ...prev, enabled: !prev.enabled }));\r\n    if (!notificationSettings.enabled) setExpanded(true);\r\n  };\r\n\r\n  return (\r\n    <div style={{ display: 'flex', alignItems: 'center', gap: '6px', position: 'relative' }}>\r\n      <button\r\n        className=\"icon-button\"\r\n        onClick={handleToggle}\r\n        title={notificationSettings.enabled ? 'Notifications on ÔÇö click to disable' : 'Enable task notifications'}\r\n        style={{ position: 'relative' }}\r\n      >\r\n        <Bell size={18} style={{ color: notificationSettings.enabled ? 'var(--accent-color)' : 'inherit' }} />\r\n        {notificationSettings.enabled && (\r\n          <span style={{\r\n            position: 'absolute', top: 4, right: 4, width: 7, height: 7,\r\n            borderRadius: '50%', background: 'var(--accent-color)',\r\n            border: '1.5px solid var(--bg-primary)'\r\n          }} />\r\n        )}\r\n      </button>\r\n      {notificationSettings.enabled && (\r\n        <div style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>\r\n          <label style={{ fontSize: '12px', color: 'var(--text-secondary)', whiteSpace: 'nowrap' }}>\r\n            Alert\r\n          </label>\r\n          <input\r\n            type=\"number\"\r\n            min=\"0\"\r\n            max=\"1440\"\r\n            value={notificationSettings.leadTime}\r\n            onChange={e => setNotificationSettings(prev => ({ ...prev, leadTime: Number(e.target.value) }))}\r\n            style={{\r\n              width: '44px', fontSize: '12px', padding: '2px 4px',\r\n              background: 'var(--bg-secondary)', border: '1px solid var(--border-color)',\r\n              borderRadius: '4px', color: 'var(--text-primary)', textAlign: 'center'\r\n            }}\r\n            title=\"Minutes before task is due to notify\"\r\n          />\r\n          <label style={{ fontSize: '12px', color: 'var(--text-secondary)', whiteSpace: 'nowrap' }}>\r\n            min before\r\n          </label>\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n\r\nfunction App() {\r\n  const { isInitializing, activeFileId, setActiveFileId, workspaceHandle, disconnectWorkspace, notificationSettings, setNotificationSettings, isDarkMode, setIsDarkMode } = useNotes();\r\n  const [sidebarOpen, setSidebarOpen] = useState(false);\r\n  const [helpOpen, setHelpOpen] = useState(false);\r\n  const [showTasks, setShowTasks] = useState(false);\r\n\r\n  useEffect(() => {\r\n    const handleKeyDown = (e) => {\r\n      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || (e.target.closest('.ProseMirror') && !e.altKey)) {\r\n        return;\r\n      }\r\n\r\n      if (e.altKey && e.key === '/') {\r\n        e.preventDefault();\r\n        setHelpOpen(prev => !prev);\r\n      }\r\n      if (e.altKey && !e.shiftKey && e.key.toLowerCase() === 'h') {\r\n        e.preventDefault();\r\n        setActiveFileId(null);\r\n        setShowTasks(false);\r\n        setSidebarOpen(false);\r\n      }\r\n      if (e.altKey && !e.shiftKey && e.key.toLowerCase() === 'e') {\r\n        e.preventDefault();\r\n        const editor = document.querySelector('.ProseMirror');\r\n        if (editor) {\r\n          editor.focus();\r\n        }\r\n      }\r\n      if (e.altKey && !e.shiftKey && e.key.toLowerCase() === 's') {\r\n        e.preventDefault();\r\n        setSidebarOpen(true);\r\n        // Explicitly focus the sidebar content or the last interacted node\r\n        setTimeout(() => {\r\n          const sidebarContent = document.querySelector('.sidebar-content');\r\n          if (sidebarContent) {\r\n            const focusedItem = sidebarContent.querySelector('.tree-item.focused') ||\r\n              sidebarContent.querySelector('.tree-item.active') ||\r\n              sidebarContent.querySelector('.tree-item');\r\n            focusedItem?.focus();\r\n          }\r\n        }, 50);\r\n      }\r\n      if (e.altKey && !e.shiftKey && e.key.toLowerCase() === 't') {\r\n        e.preventDefault();\r\n        setActiveFileId(null);\r\n        setShowTasks(true);\r\n        setSidebarOpen(false);\r\n      }\r\n      if (e.altKey && !e.shiftKey && e.key.toLowerCase() === 'w') {\r\n        e.preventDefault();\r\n        disconnectWorkspace();\r\n      }\r\n    };\r\n    window.addEventListener('keydown', handleKeyDown);\r\n    if (activeFileId && showTasks) {\r\n      setShowTasks(false);\r\n    }\r\n    return () => window.removeEventListener('keydown', handleKeyDown);\r\n  }, [activeFileId, showTasks, disconnectWorkspace]);\r\n\r\n  if (isInitializing) {\r\n    return (\r\n      <div className=\"app-container\" style={{ alignItems: 'center', justifyContent: 'center' }}>\r\n        <p style={{ color: 'var(--text-tertiary)' }}>Loading Redly...</p>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (!workspaceHandle) {\r\n    return (\r\n      <div className=\"app-container\" style={{ height: '100dvh' }}>\r\n        <WelcomeScreen openHelp={() => setHelpOpen(true)} />\r\n        <div style={{ position: 'absolute', top: 24, right: 24, zIndex: 100 }}>\r\n          <button\r\n            className=\"icon-button\"\r\n            onClick={() => setIsDarkMode(!isDarkMode)}\r\n            title=\"Toggle Theme\"\r\n            style={{ background: 'var(--bg-secondary)', border: '1px solid var(--border-color)' }}\r\n          >\r\n            {isDarkMode ? <Sun size={20} /> : <Moon size={20} />}\r\n          </button>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"app-container\">\r\n      <div\r\n        className={`sidebar-overlay ${sidebarOpen ? 'open' : ''}`}\r\n        onClick={() => setSidebarOpen(false)}\r\n      ></div>\r\n\r\n      <Sidebar\r\n        isOpen={sidebarOpen}\r\n        onClose={() => setSidebarOpen(false)}\r\n        onOpenHelp={() => setHelpOpen(true)}\r\n        setShowTasks={() => { setShowTasks(true); setActiveFileId(null); setSidebarOpen(false); }}\r\n        onGoHome={() => { setActiveFileId(null); setShowTasks(false); setSidebarOpen(false); }}\r\n      />\r\n      <HelpModal isOpen={helpOpen} onClose={() => setHelpOpen(false)} />\r\n\r\n      <main className=\"main-area\">\r\n        <div className=\"app-toolbar\" style={{ display: 'flex', gap: '16px', borderBottom: activeFileId ? '1px solid var(--border-color)' : 'none', justifyContent: 'space-between', alignItems: 'center' }}>\r\n          <div style={{ display: 'flex', gap: '16px', alignItems: 'center' }}>\r\n            <button\r\n              className=\"icon-button mobile-menu-btn\"\r\n              onClick={() => setSidebarOpen(true)}\r\n              style={{ display: 'none' }}\r\n            >\r\n              <Menu size={20} />\r\n            </button>\r\n            <style>{`\r\n              @media (max-width: 768px) {\r\n                .mobile-menu-btn { display: flex !important; }\r\n              }\r\n            `}</style>\r\n          </div>\r\n\r\n          <GlobalSearch />\r\n\r\n          <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginRight: '16px' }}>\r\n            <button\r\n              className=\"icon-button\"\r\n              onClick={() => setIsDarkMode(!isDarkMode)}\r\n              title=\"Toggle Theme\"\r\n            >\r\n              {isDarkMode ? <Sun size={20} /> : <Moon size={20} />}\r\n            </button>\r\n            <NotificationToggle />\r\n          </div>\r\n        </div>\r\n\r\n        {showTasks && <GlobalTasks />}\r\n        {!showTasks && activeFileId && <Editor key={activeFileId} fileId={activeFileId} />}\r\n        {!showTasks && !activeFileId && <WelcomeScreen openHelp={() => setHelpOpen(true)} />}\r\n      </main>\r\n    </div>\r\n  );\r\n}\r\n\r\nexport default App;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jonat\\Downloads\\redly\\src\\components\\CodeBlockComponent.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jonat\\Downloads\\redly\\src\\components\\Editor.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'getDateColor' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":24,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":24,"endColumn":22,"suggestions":[{"messageId":"removeVar","data":{"varName":"getDateColor"},"fix":{"range":[1321,1334],"text":""},"desc":"Remove unused variable 'getDateColor'."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\-.","line":44,"column":69,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":44,"endColumn":70,"suggestions":[{"messageId":"removeEscape","fix":{"range":[2160,2161],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[2160,2160],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\-.","line":61,"column":69,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":61,"endColumn":70,"suggestions":[{"messageId":"removeEscape","fix":{"range":[3194,3195],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[3194,3194],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\*.","line":221,"column":52,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":221,"endColumn":53,"suggestions":[{"messageId":"removeEscape","fix":{"range":[10741,10742],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[10741,10741],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\[.","line":221,"column":54,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":221,"endColumn":55,"suggestions":[{"messageId":"removeEscape","fix":{"range":[10743,10744],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[10743,10743],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'setBubbleMenu' is defined but never used.","line":285,"column":45,"nodeType":"Identifier","messageId":"unusedVar","endLine":285,"endColumn":58,"suggestions":[{"messageId":"removeVar","data":{"varName":"setBubbleMenu"},"fix":{"range":[13694,13709],"text":""},"desc":"Remove unused variable 'setBubbleMenu'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'forceRender' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":470,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":470,"endColumn":23,"suggestions":[{"messageId":"removeVar","data":{"varName":"forceRender"},"fix":{"range":[25602,25613],"text":""},"desc":"Remove unused variable 'forceRender'."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\-.","line":482,"column":53,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":482,"endColumn":54,"suggestions":[{"messageId":"removeEscape","fix":{"range":[26035,26036],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[26035,26035],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\/.","line":680,"column":70,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":680,"endColumn":71,"suggestions":[{"messageId":"removeEscape","fix":{"range":[34768,34769],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[34768,34768],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\..","line":680,"column":72,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":680,"endColumn":73,"suggestions":[{"messageId":"removeEscape","fix":{"range":[34770,34771],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[34770,34770],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\/.","line":680,"column":83,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":680,"endColumn":84,"suggestions":[{"messageId":"removeEscape","fix":{"range":[34781,34782],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[34781,34781],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\..","line":680,"column":85,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":680,"endColumn":86,"suggestions":[{"messageId":"removeEscape","fix":{"range":[34783,34784],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[34783,34783],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\/.","line":712,"column":70,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":712,"endColumn":71,"suggestions":[{"messageId":"removeEscape","fix":{"range":[36573,36574],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[36573,36573],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\..","line":712,"column":72,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":712,"endColumn":73,"suggestions":[{"messageId":"removeEscape","fix":{"range":[36575,36576],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[36575,36575],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\/.","line":712,"column":83,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":712,"endColumn":84,"suggestions":[{"messageId":"removeEscape","fix":{"range":[36586,36587],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[36586,36586],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\..","line":712,"column":85,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":712,"endColumn":86,"suggestions":[{"messageId":"removeEscape","fix":{"range":[36588,36589],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[36588,36588],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'offset' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":771,"column":35,"nodeType":"Identifier","messageId":"unusedVar","endLine":771,"endColumn":41,"suggestions":[{"messageId":"removeVar","data":{"varName":"offset"},"fix":{"range":[39211,39219],"text":""},"desc":"Remove unused variable 'offset'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'innerErr' is defined but never used.","line":824,"column":30,"nodeType":"Identifier","messageId":"unusedVar","endLine":824,"endColumn":38},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\-.","line":839,"column":81,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":839,"endColumn":82,"suggestions":[{"messageId":"removeEscape","fix":{"range":[42771,42772],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[42771,42771],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'e' is defined but never used.","line":863,"column":38,"nodeType":"Identifier","messageId":"unusedVar","endLine":863,"endColumn":39},{"ruleId":"no-unused-vars","severity":2,"message":"'e' is defined but never used.","line":889,"column":38,"nodeType":"Identifier","messageId":"unusedVar","endLine":889,"endColumn":39},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has missing dependencies: 'availableTags', 'tagMenu.isOpen', 'tagMenu.query', 'tagMenu.selectedIndex', and 'tagMenu.triggerIdx'. Either include them or remove the dependency array.","line":969,"column":8,"nodeType":"ArrayExpression","endLine":969,"endColumn":27,"suggestions":[{"desc":"Update the dependencies array to be: [tagMenu.isOpen, tagMenu.query, tagMenu.selectedIndex, tagMenu.triggerIdx, slashMenu.isOpen, slashMenu.query, slashMenu.selectedIndex, slashMenu.triggerIdx, availableTags, editor]","fix":{"range":[49637,49656],"text":"[tagMenu.isOpen, tagMenu.query, tagMenu.selectedIndex, tagMenu.triggerIdx, slashMenu.isOpen, slashMenu.query, slashMenu.selectedIndex, slashMenu.triggerIdx, availableTags, editor]"}}]},{"ruleId":"no-unused-vars","severity":2,"message":"'e' is defined but never used.","line":1057,"column":38,"nodeType":"Identifier","messageId":"unusedVar","endLine":1057,"endColumn":39},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'file' and 'getFileContent'. Either include them or remove the dependency array.","line":1064,"column":8,"nodeType":"ArrayExpression","endLine":1064,"endColumn":41,"suggestions":[{"desc":"Update the dependencies array to be: [fileId, nodes, editor, file.id, file, getFileContent]","fix":{"range":[54609,54642],"text":"[fileId, nodes, editor, file.id, file, getFileContent]"}}]}],"suppressedMessages":[],"errorCount":22,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect, useCallback, useRef, useMemo } from 'react';\r\nimport { useEditor, EditorContent, BubbleMenu, NodeViewWrapper, NodeViewContent, ReactNodeViewRenderer } from '@tiptap/react';\r\nimport { StarterKit } from '@tiptap/starter-kit';\r\nimport { TaskList } from '@tiptap/extension-task-list';\r\nimport { TaskItem } from '@tiptap/extension-task-item';\r\nimport { Link as TiptapLink } from '@tiptap/extension-link';\r\nimport { Placeholder } from '@tiptap/extension-placeholder';\r\nimport { Table } from '@tiptap/extension-table';\r\nimport { TableRow } from '@tiptap/extension-table-row';\r\nimport { TableCell } from '@tiptap/extension-table-cell';\r\nimport { TableHeader } from '@tiptap/extension-table-header';\r\nimport CodeBlock from '@tiptap/extension-code-block';\r\nimport CodeBlockComponent from './CodeBlockComponent';\r\nimport { Extension, Node, mergeAttributes, InputRule } from '@tiptap/core';\r\nimport { Plugin, PluginKey } from '@tiptap/pm/state';\r\nimport { Decoration, DecorationSet } from '@tiptap/pm/view';\r\nimport TurndownService from 'turndown';\r\nimport { gfm } from 'turndown-plugin-gfm';\r\nimport markdownit from 'markdown-it';\r\nimport taskLists from 'markdown-it-task-lists';\r\n\r\nimport { useNotes } from '../context/NotesContext';\r\nimport InlineDateInput from './InlineDateInput';\r\nimport { getDateColor, parseDateString } from '../utils/dateHelpers';\r\nimport {\r\n    Trash, Bold, Italic, Strikethrough, Code, Heading1, Heading2, Heading3,\r\n    List, ListOrdered, Quote, CheckSquare, Link as LinkIcon, ExternalLink,\r\n    Table as TableIcon, PlusSquare, MinusSquare, Columns, Rows, MoreHorizontal\r\n} from 'lucide-react';\r\n\r\n\r\n\r\nconst TagHighlighter = Extension.create({\r\n    name: 'tagHighlighter',\r\n    addProseMirrorPlugins() {\r\n        return [\r\n            new Plugin({\r\n                key: new PluginKey('tagHighlighter'),\r\n                state: {\r\n                    init(_, { doc }) {\r\n                        const decorations = [];\r\n                        doc.descendants((node, pos) => {\r\n                            if (node.isText && node.text) {\r\n                                const regex = /(?:^|\\s)(#[a-zA-Z0-9_\\-]+)/g;\r\n                                let match;\r\n                                while ((match = regex.exec(node.text)) !== null) {\r\n                                    const start = pos + match.index + (match[0].startsWith(' ') ? 1 : 0);\r\n                                    const end = start + match[1].length;\r\n                                    decorations.push(Decoration.inline(start, end, { class: 'editor-tag' }));\r\n                                }\r\n                            }\r\n                        });\r\n                        return DecorationSet.create(doc, decorations);\r\n                    },\r\n                    apply(transaction, oldState) {\r\n                        if (!transaction.docChanged) return oldState;\r\n                        const doc = transaction.doc;\r\n                        const decorations = [];\r\n                        doc.descendants((node, pos) => {\r\n                            if (node.isText && node.text) {\r\n                                const regex = /(?:^|\\s)(#[a-zA-Z0-9_\\-]+)/g;\r\n                                let match;\r\n                                while ((match = regex.exec(node.text)) !== null) {\r\n                                    const start = pos + match.index + (match[0].startsWith(' ') ? 1 : 0);\r\n                                    const end = start + match[1].length;\r\n                                    decorations.push(Decoration.inline(start, end, { class: 'editor-tag' }));\r\n                                }\r\n                            }\r\n                        });\r\n                        return DecorationSet.create(doc, decorations);\r\n                    },\r\n                },\r\n                props: {\r\n                    decorations(state) {\r\n                        return this.getState(state);\r\n                    },\r\n                },\r\n            }),\r\n        ];\r\n    },\r\n});\r\n\r\n// React Component for TaskItem Node View\r\nconst CustomTaskItemComponent = (props) => {\r\n    const { node, updateAttributes } = props;\r\n    if (!node || !node.attrs) return null;\r\n    const clearDate = (e) => {\r\n\r\n        if (e && e.stopPropagation) e.stopPropagation();\r\n        updateAttributes({ hasDate: false, date: '', hasTime: false });\r\n    };\r\n    const handleDateUpdate = (newDateUrlString, newHasTime) => {\r\n        updateAttributes({ date: newDateUrlString, hasDate: true, hasTime: newHasTime });\r\n    };\r\n    return (\r\n        <NodeViewWrapper as=\"li\" data-type=\"taskItem\" data-checked={node.attrs.checked} style={{ display: 'flex', alignItems: 'flex-start', margin: '4px 0', gap: '8px' }}>\r\n            <label contentEditable={false} style={{ marginTop: '4px', cursor: 'pointer', display: 'flex' }}>\r\n                <input\r\n                    type=\"checkbox\"\r\n                    checked={node.attrs.checked}\r\n                    onChange={e => {\r\n                        updateAttributes({ checked: e.target.checked });\r\n                    }}\r\n                    style={{ width: '16px', height: '16px', cursor: 'pointer' }}\r\n                />\r\n            </label>\r\n\r\n            <div style={{ flex: 1 }}>\r\n                <NodeViewContent as=\"div\" style={{\r\n                    textDecoration: node.attrs.checked ? 'line-through' : 'none',\r\n                    color: node.attrs.checked ? 'var(--text-tertiary)' : 'inherit',\r\n                    minHeight: '24px', outline: 'none'\r\n                }} />\r\n                {node.attrs.hasDate && (\r\n                    <div data-type=\"inline-date-badge\" contentEditable={false} style={{ marginTop: '2px', display: 'flex', alignItems: 'center', gap: '4px', userSelect: 'none' }}>\r\n\r\n                        <InlineDateInput\r\n                            initialDate={node.attrs.date}\r\n                            initialHasTime={node.attrs.hasTime}\r\n                            isChecked={node.attrs.checked}\r\n                            onDateChange={handleDateUpdate}\r\n                            onClearDate={clearDate}\r\n                        />\r\n                        <button onClick={clearDate} style={{ background: 'transparent', border: 'none', padding: '2px 4px', fontSize: '12px', color: 'var(--danger-color)', cursor: 'pointer' }} title=\"Remove Date\">Ô£ò</button>\r\n                    </div>\r\n                )}\r\n            </div>\r\n        </NodeViewWrapper>\r\n    );\r\n};\r\n\r\n// React Component for Inline Date Input\r\nconst InlineDateInputNodeView = (props) => {\r\n    const [value, setValue] = useState('');\r\n    const inputRef = useRef(null);\r\n    useEffect(() => { if (inputRef.current) setTimeout(() => inputRef.current?.focus(), 10); }, []);\r\n    const handleKeyDown = (e) => {\r\n        if (e.key === 'Tab') {\r\n            e.preventDefault();\r\n            const today = new Date();\r\n            setValue(`${String(today.getDate()).padStart(2, '0')}/${String(today.getMonth() + 1).padStart(2, '0')}/${today.getFullYear()}`);\r\n        } else if (e.key === 'Enter') {\r\n            e.preventDefault();\r\n            const { editor, getPos } = props;\r\n            if (typeof getPos !== 'function') return;\r\n            const pos = getPos();\r\n            if (pos === undefined) return;\r\n            const $pos = editor.state.doc.resolve(pos);\r\n            let taskItemNode = null;\r\n            for (let i = $pos.depth; i > 0; i--) { if ($pos.node(i).type.name === 'taskItem') { taskItemNode = $pos.node(i); break; } }\r\n            const { parsedDate, hasDate, hasTime } = parseDateString(value);\r\n            if (taskItemNode && hasDate) {\r\n                editor.chain().deleteRange({ from: pos, to: pos + 1 }).updateAttributes('taskItem', { date: parsedDate, hasDate, hasTime }).focus().run();\r\n            } else {\r\n                editor.chain().deleteRange({ from: pos, to: pos + 1 }).insertContent(`@${value}`).focus().run();\r\n            }\r\n        } else if (e.key === 'Escape') {\r\n            const { getPos } = props;\r\n            if (typeof getPos !== 'function') return;\r\n            const pos = getPos();\r\n            if (pos === undefined) return;\r\n            props.editor.chain().deleteRange({ from: pos, to: pos + 1 }).insertContent(`@${value}`).focus().run();\r\n        }\r\n\r\n    };\r\n    return (\r\n        <NodeViewWrapper as=\"span\" style={{ display: 'inline-flex', alignItems: 'center', background: 'var(--bg-accent)', borderRadius: '4px', padding: '0 4px', color: 'var(--accent-color)' }}>\r\n            <span style={{ fontWeight: 'bold', marginRight: '2px' }}>@</span>\r\n            <input ref={inputRef} type=\"text\" value={value} onChange={e => setValue(e.target.value)} onKeyDown={handleKeyDown}\r\n                style={{ border: 'none', outline: 'none', background: 'transparent', color: 'var(--accent-color)', fontFamily: 'monospace', fontSize: '0.9em', width: '17ch' }} />\r\n        </NodeViewWrapper>\r\n    );\r\n};\r\n\r\nconst md = markdownit({ html: true, linkify: true, typographer: true }).use(taskLists, { label: false });\r\n\r\nconst td = new TurndownService({\r\n    headingStyle: 'atx',\r\n    hr: '---',\r\n    bulletListMarker: '-',\r\n    codeBlockStyle: 'fenced',\r\n    blankReplacement: (content, node) => {\r\n        // Prevent blank replacement inside tables which can break GFM syntax\r\n        if (node.closest('table')) return content;\r\n        return node.nodeName === 'P' ? '&nbsp;\\n\\n' : (node.isBlock ? '\\n\\n' : '');\r\n    }\r\n});\r\ntd.use(gfm);\r\n\r\n// Table support fix for Tiptap's nested <p> tags\r\ntd.addRule('tableCell', {\r\n    filter: ['th', 'td'],\r\n    replacement: (content) => {\r\n        // Strip newlines and paragraph markers inside table cells to maintain GFM compatibility\r\n        return content.replace(/\\n/g, ' ').trim();\r\n    }\r\n});\r\n// Task Item serialization\r\ntd.addRule('taskItem', {\r\n    filter: (node) => node.nodeName === 'LI' && (\r\n        node.getAttribute('data-type') === 'taskItem' ||\r\n        node.classList.contains('task-list-item')\r\n    ),\r\n    replacement: (content, node) => {\r\n        const isChecked = node.getAttribute('data-checked') === 'true' ||\r\n            node.hasAttribute('checked') ||\r\n            node.classList.contains('is-checked') ||\r\n            !!node.querySelector('input[checked]') ||\r\n            !!node.querySelector('input[type=\"checkbox\"]:checked');\r\n\r\n\r\n\r\n\r\n        const date = node.getAttribute('data-date');\r\n        const hasTime = node.getAttribute('data-has-time') === 'true';\r\n\r\n        // Content should be clean text/markdown from children\r\n        let cleanContent = content.trim();\r\n\r\n        // Remove any leading/trailing list markers that might have leaked from default rules\r\n        cleanContent = cleanContent.replace(/^[\\s\\-\\*\\[\\]x]*\\s*/, '');\r\n        // Remove \"Due:\" text if added by badges\r\n        cleanContent = cleanContent.replace(/Due:\\s*[^]*?(\\n|$)/g, '').trim();\r\n\r\n        let dateString = '';\r\n        if (date) {\r\n            const formattedDate = hasTime ? date.replace('T', ' ') : date.split('T')[0];\r\n            dateString = ` @${formattedDate}`;\r\n        }\r\n\r\n        return `\\n- [${isChecked ? 'x' : ' '}] ${cleanContent}${dateString}`;\r\n    }\r\n});\r\n\r\n\r\n\r\ntd.addRule('inlineDateInput', {\r\n    filter: (node) => node.getAttribute('data-type') === 'inline-date',\r\n    replacement: (content, node) => {\r\n        const input = node.querySelector('input');\r\n        const badgeValue = node.getAttribute('data-date-value');\r\n        return `@${input ? input.value : (badgeValue || '')}`;\r\n    }\r\n});\r\n\r\n// Explicitly ignore the date badge text in Turndown\r\ntd.addRule('ignoreDateBadge', {\r\n    filter: (node) => {\r\n        // More robust filter for the date badge div\r\n        return (\r\n            (node.getAttribute('contenteditable') === 'false' && (node.innerText?.includes('Due:') || node.textContent?.includes('Due:'))) ||\r\n            node.getAttribute('data-type') === 'inline-date-badge'\r\n        );\r\n    },\r\n    replacement: () => ''\r\n});\r\n\r\ntd.addRule('fencedCodeBlock', {\r\n    filter: 'pre',\r\n    replacement: (content, node) => {\r\n        const code = node.innerText || node.textContent || '';\r\n        return `\\n\\n\\`\\`\\`\\n${code.trim()}\\n\\`\\`\\`\\n\\n`;\r\n    }\r\n});\r\n\r\nconst SLASH_OPTIONS = [\r\n    { label: 'Heading 1', icon: 'H1', command: (editor) => editor.chain().focus().toggleHeading({ level: 1 }).run() },\r\n    { label: 'Heading 2', icon: 'H2', command: (editor) => editor.chain().focus().toggleHeading({ level: 2 }).run() },\r\n    { label: 'Heading 3', icon: 'H3', command: (editor) => editor.chain().focus().toggleHeading({ level: 3 }).run() },\r\n    { label: 'Bold', icon: 'B', command: (editor) => editor.chain().focus().toggleBold().run() },\r\n    { label: 'Italic', icon: 'I', command: (editor) => editor.chain().focus().toggleItalic().run() },\r\n    { label: 'Bulleted List', icon: 'ÔÇó', command: (editor) => editor.chain().focus().toggleBulletList().run() },\r\n    { label: 'Numbered List', icon: '1.', command: (editor) => editor.chain().focus().toggleOrderedList().run() },\r\n    { label: 'Todo List', icon: 'ÔÿÉ', command: (editor) => editor.chain().focus().toggleTaskList().run() },\r\n    { label: 'Quote', icon: 'ÔÇØ', command: (editor) => editor.chain().focus().toggleBlockquote().run() },\r\n    { label: 'Code Block', icon: '</>', command: (editor) => editor.chain().focus().toggleCodeBlock().run() },\r\n    {\r\n        label: 'Table', icon: 'þö░', command: (editor) => {\r\n            editor.chain().focus().insertTable({ rows: 3, cols: 3, withHeaderRow: true }).run();\r\n        }\r\n    },\r\n    { label: 'Divider', icon: 'ÔÇö', command: (editor) => editor.chain().focus().setHorizontalRule().run() },\r\n];\r\n\r\nconst BubbleMenuUI = ({ editor, bubbleMenu, setBubbleMenu }) => {\r\n    const [, setTick] = useState(0);\r\n\r\n    useEffect(() => {\r\n        if (!editor || !bubbleMenu.isOpen) return;\r\n        const update = () => setTick(t => t + 1);\r\n        editor.on('transaction', update);\r\n        return () => editor.off('transaction', update);\r\n    }, [editor, bubbleMenu.isOpen]);\r\n\r\n    if (!bubbleMenu.isOpen || !editor || typeof bubbleMenu.top !== 'number' || typeof bubbleMenu.left !== 'number') return null;\r\n\r\n    return (\r\n        <div\r\n            className=\"custom-bubble-menu\"\r\n            style={{ position: 'fixed', top: bubbleMenu.top, left: bubbleMenu.left, zIndex: 100 }}\r\n            onMouseDown={(e) => e.preventDefault()} // Prevent stealing focus from the editor\r\n        >\r\n            <button onClick={() => editor.chain().focus().toggleHeading({ level: 1 }).run()} className={editor.isActive('heading', { level: 1 }) ? 'is-active' : ''} title=\"Heading 1\"><Heading1 size={16} /></button>\r\n            <button onClick={() => editor.chain().focus().toggleHeading({ level: 2 }).run()} className={editor.isActive('heading', { level: 2 }) ? 'is-active' : ''} title=\"Heading 2\"><Heading2 size={16} /></button>\r\n            <button onClick={() => editor.chain().focus().toggleHeading({ level: 3 }).run()} className={editor.isActive('heading', { level: 3 }) ? 'is-active' : ''} title=\"Heading 3\"><Heading3 size={16} /></button>\r\n            <button onClick={() => editor.chain().focus().setParagraph().run()} className={editor.isActive('paragraph') ? 'is-active' : ''} title=\"Text\"><span style={{ fontSize: '12px', fontWeight: 'bold' }}>T</span></button>\r\n\r\n            <button onClick={() => editor.chain().focus().toggleBold().run()} className={editor.isActive('bold') ? 'is-active' : ''} title=\"Bold\"><Bold size={16} /></button>\r\n            <button onClick={() => editor.chain().focus().toggleItalic().run()} className={editor.isActive('italic') ? 'is-active' : ''} title=\"Italic\"><Italic size={16} /></button>\r\n            <button onClick={() => editor.chain().focus().toggleStrike().run()} className={editor.isActive('strike') ? 'is-active' : ''} title=\"Strikethrough\"><Strikethrough size={16} /></button>\r\n\r\n            {!editor.isActive('link') && (\r\n                <button\r\n                    onClick={() => {\r\n                        const url = window.prompt('URL');\r\n                        if (url) editor.chain().focus().setLink({ href: url }).run();\r\n                    }}\r\n                    title=\"Add Link\"\r\n                >\r\n                    <LinkIcon size={16} />\r\n                </button>\r\n            )}\r\n\r\n            {editor.isActive('link') && (\r\n                <>\r\n                    <button\r\n                        onClick={() => {\r\n                            const currentUrl = editor.getAttributes('link').href;\r\n                            const url = window.prompt('Edit URL', currentUrl);\r\n                            if (url === null) return;\r\n\r\n                            // Accurately find the link bounds\r\n                            const { selection, doc } = editor.state;\r\n                            let linkStart = selection.from;\r\n                            let linkEnd = selection.to;\r\n\r\n                            doc.nodesBetween(selection.from, selection.to, (node, pos) => {\r\n                                if (node.marks.find(m => m.type.name === 'link')) {\r\n                                    linkStart = Math.min(linkStart, pos);\r\n                                    linkEnd = Math.max(linkEnd, pos + node.nodeSize);\r\n                                }\r\n                            });\r\n\r\n                            const currentText = doc.textBetween(linkStart, linkEnd, ' ');\r\n                            const text = window.prompt('Edit Display Text', currentText);\r\n\r\n                            if (url === '') {\r\n                                editor.chain().focus().extendMarkRange('link').unsetLink().run();\r\n                                if (text !== null && text !== currentText) {\r\n                                    editor.chain().focus().deleteRange({ from: linkStart, to: linkEnd }).insertContent(text).run();\r\n                                }\r\n                                return;\r\n                            }\r\n\r\n                            if (text !== null && text !== currentText) {\r\n                                editor.chain().focus()\r\n                                    .deleteRange({ from: linkStart, to: linkEnd })\r\n                                    .insertContent({\r\n                                        type: 'text',\r\n                                        text: text,\r\n                                        marks: [{ type: 'link', attrs: { href: url } }]\r\n                                    })\r\n                                    .run();\r\n                            } else {\r\n                                editor.chain().focus().extendMarkRange('link').setLink({ href: url }).run();\r\n                            }\r\n                        }}\r\n                        className=\"is-active\"\r\n                        title=\"Edit Link\"\r\n                        style={{ fontSize: '12px', padding: '4px 8px', whiteSpace: 'nowrap' }}\r\n                    >\r\n                        Edit Link\r\n                    </button>\r\n                    <button\r\n                        onClick={() => {\r\n                            editor.chain().focus().extendMarkRange('link').unsetLink().run();\r\n                        }}\r\n                        title=\"Remove Link\"\r\n                        style={{ color: 'var(--danger-color)', fontSize: '12px', padding: '4px 8px', whiteSpace: 'nowrap' }}\r\n                    >\r\n                        Unlink\r\n                    </button>\r\n                </>\r\n            )}\r\n\r\n            <button onClick={() => editor.chain().focus().toggleCode().run()} className={editor.isActive('code') ? 'is-active' : ''} title=\"Code Inline\"><Code size={16} /></button>\r\n            <div className=\"menu-separator\" />\r\n            <button onClick={() => editor.chain().focus().toggleBulletList().run()} className={editor.isActive('bulletList') ? 'is-active' : ''} title=\"Bullet List\"><List size={16} /></button>\r\n            <button onClick={() => editor.chain().focus().toggleOrderedList().run()} className={editor.isActive('orderedList') ? 'is-active' : ''} title=\"Numbered List\"><ListOrdered size={16} /></button>\r\n            <button onClick={() => editor.chain().focus().toggleTaskList().run()} className={editor.isActive('taskList') ? 'is-active' : ''} title=\"Todo List\"><CheckSquare size={16} /></button>\r\n            <button onClick={() => editor.chain().focus().toggleBlockquote().run()} className={editor.isActive('blockquote') ? 'is-active' : ''} title=\"Quote\"><Quote size={16} /></button>\r\n            <button onClick={() => editor.chain().focus().toggleCodeBlock().run()} className={editor.isActive('codeBlock') ? 'is-active' : ''} title=\"Code Block\"><ExternalLink size={16} /></button>\r\n        </div>\r\n    );\r\n};\r\n\r\nconst TableControlsMenu = ({ editor, trigger, onClose }) => {\r\n    const [, setTick] = useState(0);\r\n    const menuRef = useRef(null);\r\n\r\n    useEffect(() => {\r\n        if (!editor || !trigger) return;\r\n        const update = () => setTick(t => t + 1);\r\n        editor.on('transaction', update);\r\n        return () => editor.off('transaction', update);\r\n    }, [editor, trigger]);\r\n\r\n    // Close when clicking outside\r\n    useEffect(() => {\r\n        const handleClickOutside = (e) => {\r\n            if (menuRef.current && !menuRef.current.contains(e.target)) {\r\n                onClose();\r\n            }\r\n        };\r\n        if (trigger) {\r\n            document.addEventListener('mousedown', handleClickOutside);\r\n        }\r\n        return () => document.removeEventListener('mousedown', handleClickOutside);\r\n    }, [trigger, onClose]);\r\n\r\n    if (!editor.isActive('table') || !trigger) return null;\r\n\r\n    return (\r\n        <div\r\n            ref={menuRef}\r\n            className=\"custom-bubble-menu table-controls-enhanced\"\r\n            style={{ position: 'fixed', top: trigger.bottom + 8, left: trigger.right, transform: 'translateX(-100%)', zIndex: 110 }}\r\n            onMouseDown={(e) => e.preventDefault()}\r\n        >\r\n            <div className=\"table-controls-group\">\r\n                <span className=\"table-group-label\" style={{ fontSize: '11px', fontWeight: 'bold', color: 'var(--text-tertiary)', textTransform: 'uppercase', padding: '4px 8px', display: 'flex' }}>Columns</span>\r\n                <button onClick={() => { editor.chain().focus().addColumnBefore().run(); onClose(); }} title=\"Add Column Left\"><Columns size={14} style={{ transform: 'rotate(90deg)' }} /> Add Left</button>\r\n                <button onClick={() => { editor.chain().focus().addColumnAfter().run(); onClose(); }} title=\"Add Column Right\"><Columns size={14} style={{ transform: 'rotate(-90deg)' }} /> Add Right</button>\r\n                <button onClick={() => { editor.chain().focus().deleteColumn().run(); onClose(); }} title=\"Delete Column\" className=\"danger-btn\"><Columns size={14} /> Delete Col</button>\r\n            </div>\r\n\r\n            <div className=\"menu-separator-vertical\"></div>\r\n\r\n            <div className=\"table-controls-group\">\r\n                <span className=\"table-group-label\" style={{ fontSize: '11px', fontWeight: 'bold', color: 'var(--text-tertiary)', textTransform: 'uppercase', padding: '4px 8px', display: 'flex' }}>Rows</span>\r\n                <button onClick={() => { editor.chain().focus().addRowBefore().run(); onClose(); }} title=\"Add Row Above\"><Rows size={14} /> Add Above</button>\r\n                <button onClick={() => { editor.chain().focus().addRowAfter().run(); onClose(); }} title=\"Add Row Below\"><Rows size={14} /> Add Below</button>\r\n                <button onClick={() => { editor.chain().focus().deleteRow().run(); onClose(); }} title=\"Delete Row\" className=\"danger-btn\"><Rows size={14} /> Delete Row</button>\r\n            </div>\r\n\r\n            <div className=\"menu-separator-vertical\"></div>\r\n\r\n            <div className=\"table-controls-group\">\r\n                <span className=\"table-group-label\" style={{ fontSize: '11px', fontWeight: 'bold', color: 'var(--text-tertiary)', textTransform: 'uppercase', padding: '4px 8px', display: 'flex' }}>Table</span>\r\n                <button onClick={() => { editor.chain().focus().toggleHeaderRow().run(); onClose(); }} className={editor.isActive('tableHeader') ? 'is-active' : ''} title=\"Toggle Header\"><span style={{ fontWeight: 'bold', width: '14px', textAlign: 'center' }}>H</span> Toggle Header</button>\r\n                <button onClick={() => { editor.chain().focus().deleteTable().run(); onClose(); }} title=\"Delete Table\" className=\"danger-btn\"><Trash size={14} /> Delete Table</button>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default function Editor({ fileId }) {\r\n    const { nodes, editNode, removeNode, getFileContent, ensureAllContentsLoaded } = useNotes();\r\n    const [file, setFile] = useState(null);\r\n    const saveTimeoutRef = useRef(null);\r\n    const lastSavedContentRef = useRef(''); // Track the last saved state to prevent echo updates\r\n    const [localTitle, setLocalTitle] = useState('');\r\n    const pendingUpdatesRef = useRef({}); // Merge updates (name, content) to prevent race conditions during renames\r\n    const [slashMenu, setSlashMenu] = useState({ isOpen: false, top: 0, left: 0, query: '', triggerIdx: -1, selectedIndex: 0 });\r\n    const [tagMenu, setTagMenu] = useState({ isOpen: false, top: 0, left: 0, query: '', triggerIdx: -1, selectedIndex: 0 });\r\n    const [availableTags, setAvailableTags] = useState([]);\r\n    const [bubbleMenu, setBubbleMenu] = useState({ isOpen: false, top: 0, left: 0 });\r\n    const [tableTriggerCoords, setTableTriggerCoords] = useState(null);\r\n    const [isTableMenuOpen, setIsTableMenuOpen] = useState(false);\r\n    const [forceRender, setForceRender] = useState(0);\r\n    const slashMenuListRef = useRef(null);\r\n    const tagMenuListRef = useRef(null);\r\n\r\n    useEffect(() => {\r\n        ensureAllContentsLoaded();\r\n    }, [ensureAllContentsLoaded]);\r\n\r\n    useEffect(() => {\r\n        const tagSet = new Set();\r\n        nodes.forEach(n => {\r\n            if (n.content && typeof n.content === 'string') {\r\n                const regex = /(?:^|\\s)#([a-zA-Z0-9_\\-]+)/g;\r\n                let match;\r\n                while ((match = regex.exec(n.content)) !== null) {\r\n                    tagSet.add(match[1]); // Ensure case preservation\r\n                }\r\n            }\r\n        });\r\n\r\n        // Remove duplicates case-insensitively, but keep original casing for display\r\n        const uniqueTags = [];\r\n        const seenLower = new Set();\r\n        Array.from(tagSet).forEach(tag => {\r\n            if (!seenLower.has(tag.toLowerCase())) {\r\n                seenLower.add(tag.toLowerCase());\r\n                uniqueTags.push(tag);\r\n            }\r\n        });\r\n\r\n        setAvailableTags(uniqueTags.sort((a, b) => a.toLowerCase().localeCompare(b.toLowerCase())));\r\n    }, [nodes]);\r\n\r\n    const debouncedSave = useCallback((updates) => {\r\n        // Merge new updates into the pending buffer\r\n        pendingUpdatesRef.current = { ...pendingUpdatesRef.current, ...updates };\r\n\r\n        if (saveTimeoutRef.current) clearTimeout(saveTimeoutRef.current);\r\n        saveTimeoutRef.current = setTimeout(async () => {\r\n            const currentUpdates = { ...pendingUpdatesRef.current };\r\n            pendingUpdatesRef.current = {}; // Clear buffer BEFORE the async call\r\n\r\n            if (currentUpdates.content) {\r\n                currentUpdates.content = td.turndown(currentUpdates.content);\r\n                lastSavedContentRef.current = currentUpdates.content;\r\n            }\r\n            editNode(fileId, currentUpdates);\r\n        }, 1000);\r\n    }, [fileId, editNode]);\r\n\r\n    const extensions = useMemo(() => [\r\n        TagHighlighter,\r\n        StarterKit.configure({\r\n            heading: { levels: [1, 2, 3] },\r\n            history: true,\r\n            codeBlock: false,\r\n        }),\r\n        CodeBlock.extend({\r\n            addNodeView() {\r\n                return ReactNodeViewRenderer(CodeBlockComponent);\r\n            }\r\n        }).configure({\r\n            HTMLAttributes: { class: 'tiptap-code-block' },\r\n        }),\r\n        TiptapLink.configure({\r\n            openOnClick: false,\r\n            autolink: true,\r\n            linkOnPaste: true,\r\n            HTMLAttributes: {\r\n                class: 'editor-link',\r\n                rel: 'noopener noreferrer',\r\n                target: '_blank',\r\n            },\r\n        }),\r\n        Table.configure({\r\n            resizable: true,\r\n        }),\r\n        TableRow,\r\n        TableHeader,\r\n        TableCell,\r\n        Placeholder.configure({ placeholder: \"Start typing...\" }),\r\n\r\n        TaskList.configure({\r\n            HTMLAttributes: { 'data-type': 'taskList', class: 'task-list' },\r\n        }).extend({\r\n            parseHTML() {\r\n                return [\r\n                    { tag: 'ul[data-type=\"taskList\"]', priority: 100 },\r\n                    { tag: 'ul.task-list', priority: 100 },\r\n                ];\r\n            }\r\n        }),\r\n        TaskItem.configure({\r\n            HTMLAttributes: { 'data-type': 'taskItem', class: 'task-list-item' },\r\n            keepAttributes: false,\r\n        }).extend({\r\n            addAttributes() {\r\n                return {\r\n                    checked: {\r\n                        default: false,\r\n                        keepAttributes: true,\r\n                        parseHTML: element => {\r\n                            if (element.hasAttribute('data-checked')) return element.getAttribute('data-checked') === 'true';\r\n                            if (element.hasAttribute('checked')) return true;\r\n                            const checkbox = element.querySelector('input[type=\"checkbox\"]');\r\n                            return checkbox ? checkbox.checked : false;\r\n                        },\r\n                        renderHTML: attributes => ({\r\n                            'data-checked': attributes.checked,\r\n                            checked: attributes.checked ? 'checked' : null\r\n                        })\r\n                    },\r\n                    date: {\r\n                        default: '',\r\n                        parseHTML: element => {\r\n                            const attrDate = element.getAttribute('data-date');\r\n                            if (attrDate) {\r\n                                // Normalize space-separated ISO dates to T-format: \"2026-02-25 22:00\" -> \"2026-02-25T22:00\"\r\n                                return attrDate.replace(/^(\\d{4}-\\d{2}-\\d{2}) (\\d{2}:\\d{2})$/, '$1T$2');\r\n                            }\r\n\r\n                            // Fallback: try to extract from text content\r\n                            const text = element.textContent || '';\r\n                            const dateRegex = /@(\\d{4}-\\d{2}-\\d{2}(?:\\s+\\d{2}:\\d{2})?)/;\r\n                            const match = text.match(dateRegex);\r\n                            if (match) {\r\n                                const { parsedDate } = parseDateString(match[1]);\r\n                                return parsedDate;\r\n                            }\r\n                            return '';\r\n                        },\r\n                        renderHTML: attributes => ({ 'data-date': attributes.date })\r\n                    },\r\n\r\n                    hasTime: {\r\n                        default: false,\r\n                        parseHTML: element => {\r\n                            if (element.getAttribute('data-has-time')) return element.getAttribute('data-has-time') === 'true';\r\n                            const text = element.textContent || '';\r\n                            return /@\\d{4}-\\d{2}-\\d{2}\\s+\\d{2}:\\d{2}/.test(text);\r\n                        },\r\n                        renderHTML: attributes => ({ 'data-has-time': attributes.hasTime })\r\n                    },\r\n                    hasDate: {\r\n                        default: false,\r\n                        parseHTML: element => {\r\n                            if (element.getAttribute('data-has-date')) return element.getAttribute('data-has-date') === 'true';\r\n                            if (element.getAttribute('data-date')) return true;\r\n                            const text = element.textContent || '';\r\n                            return /@\\d{4}-\\d{2}-\\d{2}/.test(text);\r\n                        },\r\n                        renderHTML: attributes => ({ 'data-has-date': attributes.hasDate })\r\n                    }\r\n                };\r\n            },\r\n\r\n\r\n\r\n\r\n\r\n            addNodeView() { return ReactNodeViewRenderer(CustomTaskItemComponent); },\r\n\r\n            addKeyboardShortcuts() {\r\n                return {\r\n                    Enter: () => this.editor.commands.splitListItem(this.name, { checked: false, date: '', hasDate: false, hasTime: false }),\r\n                };\r\n            },\r\n\r\n            renderHTML({ node, HTMLAttributes }) {\r\n                // Ensure data-checked accurately reflects the checked attribute\r\n                return ['li', mergeAttributes(HTMLAttributes, {\r\n                    'data-type': 'taskItem',\r\n                    'data-checked': node.attrs.checked ? 'true' : 'false'\r\n                }), 0];\r\n            },\r\n\r\n\r\n\r\n\r\n            addInputRules() {\r\n                return [\r\n                    new InputRule({\r\n                        find: /^\\s*(\\[([ |xX])\\])\\s$/,\r\n                        handler: ({ state, range, match }) => {\r\n                            const checked = match[2].toLowerCase() === 'x';\r\n                            const { tr } = state;\r\n                            tr.delete(range.from, range.to);\r\n                            return tr.setBlockType(range.from, this.type, { checked });\r\n                        },\r\n                    }),\r\n                ];\r\n            },\r\n            parseHTML() {\r\n                return [\r\n                    { tag: 'li[data-type=\"taskItem\"]', priority: 101 },\r\n                    { tag: 'li', getAttrs: element => element.classList.contains('task-list-item') && { 'data-type': 'taskItem' } },\r\n                    {\r\n                        tag: 'li.task-list-item',\r\n                        priority: 100,\r\n                        getAttrs: node => {\r\n                            const checkbox = node.querySelector('input[type=\"checkbox\"]');\r\n                            const dateAttr = node.getAttribute('data-date');\r\n                            const hasTimeAttr = node.getAttribute('data-has-time') === 'true';\r\n\r\n                            if (dateAttr) {\r\n                                return { checked: checkbox ? checkbox.checked : false, date: dateAttr, hasDate: true, hasTime: hasTimeAttr };\r\n                            }\r\n\r\n                            // Fallback: Parse from text content (needed for initial load from Markdown)\r\n                            const text = node.innerText || node.textContent || '';\r\n                            const dateMatch = text.match(/@(\\d{2,4}[-\\/\\. ]\\d{2}[-\\/\\. ]\\d{2,4}(?:\\s\\d{2}:\\d{2})?)/);\r\n                            if (dateMatch) {\r\n                                const { parsedDate, hasDate, hasTime } = parseDateString(dateMatch[1]);\r\n                                if (hasDate) {\r\n                                    return { checked: checkbox ? checkbox.checked : false, date: parsedDate, hasDate, hasTime };\r\n                                }\r\n                            }\r\n\r\n                            return { checked: checkbox ? checkbox.checked : false, date: '', hasDate: false, hasTime: false };\r\n                        }\r\n\r\n                    },\r\n                    {\r\n                        tag: 'li',\r\n                        priority: 50,\r\n                        getAttrs: node => {\r\n                            const isTaskListItem = node.classList.contains('task-list-item') ||\r\n                                node.getAttribute('data-type') === 'taskItem' ||\r\n                                node.querySelector('input[type=\"checkbox\"]');\r\n\r\n                            if (!isTaskListItem) return false;\r\n\r\n                            const checkbox = node.querySelector('input[type=\"checkbox\"]');\r\n                            const dateAttr = node.getAttribute('data-date');\r\n                            const hasTimeAttr = node.getAttribute('data-has-time') === 'true';\r\n\r\n                            if (dateAttr) {\r\n                                return { checked: checkbox ? checkbox.checked : false, date: dateAttr, hasDate: true, hasTime: hasTimeAttr };\r\n                            }\r\n\r\n                            // Fallback: Parse from text content\r\n                            const text = node.innerText || node.textContent || '';\r\n                            const dateMatch = text.match(/@(\\d{2,4}[-\\/\\. ]\\d{2}[-\\/\\. ]\\d{2,4}(?:\\s\\d{2}:\\d{2})?)/);\r\n                            if (dateMatch) {\r\n                                const { parsedDate, hasDate, hasTime } = parseDateString(dateMatch[1]);\r\n                                if (hasDate) {\r\n                                    return { checked: checkbox ? checkbox.checked : false, date: parsedDate, hasDate, hasTime };\r\n                                }\r\n                            }\r\n\r\n                            return { checked: checkbox ? checkbox.checked : false, date: '', hasDate: false, hasTime: false };\r\n                        }\r\n\r\n                    }\r\n                ];\r\n            }\r\n\r\n        }),\r\n        Node.create({\r\n            name: 'inlineDateInput', group: 'inline', inline: true, atom: true,\r\n            parseHTML() { return [{ tag: 'span[data-type=\"inline-date\"]' }]; },\r\n            renderHTML({ HTMLAttributes }) { return ['span', mergeAttributes(HTMLAttributes, { 'data-type': 'inline-date' })]; },\r\n            addNodeView() { return ReactNodeViewRenderer(InlineDateInputNodeView); },\r\n            addInputRules() {\r\n                return [new InputRule({\r\n                    find: /(?:^|\\s)(@)$/,\r\n                    handler: ({ state, range }) => {\r\n                        // SCOPE FIX: Only trigger inside a taskItem\r\n                        const $pos = state.doc.resolve(range.from);\r\n                        let isInsideTask = false;\r\n                        for (let i = $pos.depth; i > 0; i--) {\r\n                            if ($pos.node(i).type.name === 'taskItem') {\r\n                                isInsideTask = true;\r\n                                break;\r\n                            }\r\n                        }\r\n                        if (!isInsideTask) return null;\r\n\r\n                        state.tr.replaceWith(range.from + 1, range.to, this.type.create());\r\n                    }\r\n                })];\r\n            }\r\n\r\n        })\r\n    ], []);\r\n\r\n    const editor = useEditor({\r\n        extensions,\r\n        content: '',\r\n        onUpdate: ({ editor }) => debouncedSave({ content: editor.getHTML() }),\r\n        onTransaction: () => {\r\n            // Force UI to re-read editor.isActive() to eliminate active state delays\r\n            setForceRender(prev => prev + 1);\r\n        },\r\n        onSelectionUpdate: ({ editor }) => {\r\n            try {\r\n                const { from, to, empty } = editor.state.selection;\r\n\r\n                // Handle Table floating \"trigger\" button visibility\r\n                if (editor.isActive('table')) {\r\n                    const view = editor.view;\r\n                    const { node, offset } = view.domAtPos(from);\r\n                    let tableElement = node;\r\n                    while (tableElement && tableElement.tagName !== 'TABLE' && tableElement.closest) {\r\n                        tableElement = tableElement.closest('table');\r\n                    }\r\n                    if (tableElement) {\r\n                        const rect = tableElement.getBoundingClientRect();\r\n                        // Anchor to top-right of table\r\n                        setTableTriggerCoords({\r\n                            top: rect.top,\r\n                            right: rect.right,\r\n                            bottom: rect.bottom, // Optional, useful if we want menu below\r\n                            isTableTrigger: true\r\n                        });\r\n                    }\r\n                } else {\r\n                    setTableTriggerCoords(null);\r\n                    setIsTableMenuOpen(false);\r\n                }\r\n\r\n                // Selection can sometimes be out of sync with the view during rapid changes\r\n                if (from < 0 || to > editor.state.doc.content.size) {\r\n                    setBubbleMenu({ isOpen: false, top: 0, left: 0 });\r\n                    return;\r\n                }\r\n\r\n                if (!empty && (to - from) < 5000) {\r\n                    // VERIFY VIEW: Ensure the editor view is ready and not destroyed\r\n                    if (!editor.view || !editor.view.domAtPos) {\r\n                        setBubbleMenu({ isOpen: false, top: 0, left: 0 });\r\n                        return;\r\n                    }\r\n\r\n                    // DEEP SAFETY: Check if the position exists in the current view mapping\r\n                    try {\r\n                        const { node } = editor.view.domAtPos(from);\r\n                        if (!node) {\r\n                            setBubbleMenu({ isOpen: false, top: 0, left: 0 });\r\n                            return;\r\n                        }\r\n\r\n                        // Use coordsAtPos for the end of the selection to place the menu nicely\r\n                        const coords = editor.view.coordsAtPos(to);\r\n                        if (coords && typeof coords.top === 'number' && typeof coords.left === 'number') {\r\n                            setBubbleMenu({\r\n                                isOpen: true,\r\n                                top: coords.top - 50,\r\n                                left: coords.left\r\n                            });\r\n                            setSlashMenu(prev => ({ ...prev, isOpen: false }));\r\n                        } else {\r\n                            setBubbleMenu({ isOpen: false, top: 0, left: 0 });\r\n                        }\r\n                    } catch (innerErr) {\r\n                        // This handles cases where domAtPos or coordsAtPos throws\r\n                        setBubbleMenu({ isOpen: false, top: 0, left: 0 });\r\n                    }\r\n                } else {\r\n                    setBubbleMenu({ isOpen: false, top: 0, left: 0 });\r\n\r\n                    if (empty) {\r\n                        const $pos = editor.state.doc.resolve(from);\r\n                        const parent = $pos.parent;\r\n                        if (!parent) return;\r\n\r\n                        // textBetween can throw if offsets are invalid\r\n                        const textBefore = parent.textBetween(0, Math.min($pos.parentOffset, parent.content.size), '\\n');\r\n                        const slashMatch = textBefore.match(/(?:^|\\s)\\/([a-zA-Z0-9]*)$/);\r\n                        const tagMatch = textBefore.match(/(?:^|\\s)#([a-zA-Z0-9_\\-]*)$/);\r\n\r\n                        if (slashMatch) {\r\n                            const query = slashMatch[1];\r\n                            const triggerIdx = from - query.length - 1;\r\n\r\n                            try {\r\n                                const coords = editor.view.coordsAtPos(triggerIdx);\r\n                                if (coords && typeof coords.bottom === 'number' && typeof coords.left === 'number') {\r\n                                    const menuHeight = 320;\r\n                                    const viewportHeight = window.innerHeight;\r\n                                    const wouldOverflow = coords.bottom + menuHeight > viewportHeight - 20;\r\n\r\n                                    setSlashMenu({\r\n                                        isOpen: true,\r\n                                        top: wouldOverflow ? Math.max(10, coords.top - menuHeight - 10) : coords.bottom + 4,\r\n                                        left: coords.left,\r\n                                        query: query,\r\n                                        triggerIdx: triggerIdx,\r\n                                        selectedIndex: 0\r\n                                    });\r\n                                } else {\r\n                                    setSlashMenu(prev => ({ ...prev, isOpen: false }));\r\n                                }\r\n                            } catch (e) {\r\n                                setSlashMenu(prev => ({ ...prev, isOpen: false }));\r\n                            }\r\n                            setTagMenu(prev => ({ ...prev, isOpen: false }));\r\n                        } else if (tagMatch) {\r\n                            const query = tagMatch[1];\r\n                            const triggerIdx = from - query.length - 1;\r\n\r\n                            try {\r\n                                const coords = editor.view.coordsAtPos(triggerIdx);\r\n                                if (coords && typeof coords.bottom === 'number' && typeof coords.left === 'number') {\r\n                                    const menuHeight = 200;\r\n                                    const viewportHeight = window.innerHeight;\r\n                                    const wouldOverflow = coords.bottom + menuHeight > viewportHeight - 20;\r\n\r\n                                    setTagMenu({\r\n                                        isOpen: true,\r\n                                        top: wouldOverflow ? Math.max(10, coords.top - menuHeight - 10) : coords.bottom + 4,\r\n                                        left: coords.left,\r\n                                        query: query || '',\r\n                                        triggerIdx: triggerIdx,\r\n                                        selectedIndex: 0\r\n                                    });\r\n                                } else {\r\n                                    setTagMenu(prev => ({ ...prev, isOpen: false }));\r\n                                }\r\n                            } catch (e) {\r\n                                setTagMenu(prev => ({ ...prev, isOpen: false }));\r\n                            }\r\n                            setSlashMenu(prev => ({ ...prev, isOpen: false }));\r\n                        } else {\r\n                            setSlashMenu(prev => ({ ...prev, isOpen: false }));\r\n                            setTagMenu(prev => ({ ...prev, isOpen: false }));\r\n                        }\r\n                    }\r\n                }\r\n            } catch (err) {\r\n                console.error('Editor: Selection update error', err);\r\n                setBubbleMenu({ isOpen: false, top: 0, left: 0 });\r\n                setSlashMenu(prev => ({ ...prev, isOpen: false }));\r\n            }\r\n        },\r\n\r\n        onBlur: () => {\r\n            setBubbleMenu({ isOpen: false, top: 0, left: 0 });\r\n            setSlashMenu(prev => ({ ...prev, isOpen: false }));\r\n            setTagMenu(prev => ({ ...prev, isOpen: false }));\r\n        }\r\n\r\n    });\r\n\r\n    const handleTitleChange = useCallback((e) => {\r\n        const newName = e.target.value;\r\n        setLocalTitle(newName);\r\n        debouncedSave({ name: newName });\r\n    }, [debouncedSave]);\r\n\r\n    const handleKeyDown = useCallback((e) => {\r\n        if (tagMenu.isOpen) {\r\n            const query = tagMenu.query || '';\r\n            const filteredTags = availableTags.filter(tag => tag && tag.toLowerCase().includes(query.toLowerCase()));\r\n            if (e.key === 'ArrowDown') {\r\n                e.preventDefault();\r\n                setTagMenu(prev => ({ ...prev, selectedIndex: (prev.selectedIndex + 1) % (filteredTags.length || 1) }));\r\n            } else if (e.key === 'ArrowUp') {\r\n                e.preventDefault();\r\n                setTagMenu(prev => ({ ...prev, selectedIndex: (prev.selectedIndex - 1 + (filteredTags.length || 1)) % (filteredTags.length || 1) }));\r\n            } else if (e.key === 'Enter') {\r\n                e.preventDefault();\r\n                const selectedTag = filteredTags[tagMenu.selectedIndex];\r\n                if (selectedTag) {\r\n                    editor.chain().focus().deleteRange({ from: tagMenu.triggerIdx, to: editor.state.selection.from }).insertContent(`#${selectedTag} `).run();\r\n                    setTagMenu(prev => ({ ...prev, isOpen: false }));\r\n                } else if (query) {\r\n                    editor.chain().focus().deleteRange({ from: tagMenu.triggerIdx, to: editor.state.selection.from }).insertContent(`#${query} `).run();\r\n                    setTagMenu(prev => ({ ...prev, isOpen: false }));\r\n                }\r\n            } else if (e.key === 'Escape') {\r\n                setTagMenu(prev => ({ ...prev, isOpen: false }));\r\n            }\r\n            return;\r\n        }\r\n\r\n        if (!slashMenu.isOpen) return;\r\n\r\n        const filteredOptions = SLASH_OPTIONS.filter(opt =>\r\n            opt.label.toLowerCase().includes(slashMenu.query.toLowerCase())\r\n        );\r\n\r\n        if (e.key === 'ArrowDown') {\r\n            e.preventDefault();\r\n            setSlashMenu(prev => ({ ...prev, selectedIndex: (prev.selectedIndex + 1) % filteredOptions.length }));\r\n        } else if (e.key === 'ArrowUp') {\r\n            e.preventDefault();\r\n            setSlashMenu(prev => ({ ...prev, selectedIndex: (prev.selectedIndex - 1 + filteredOptions.length) % filteredOptions.length }));\r\n        } else if (e.key === 'Enter') {\r\n            e.preventDefault();\r\n            const selectedOption = filteredOptions[slashMenu.selectedIndex];\r\n            if (selectedOption) {\r\n                editor.chain().focus().deleteRange({ from: slashMenu.triggerIdx, to: editor.state.selection.from }).run();\r\n                selectedOption.command(editor);\r\n                setSlashMenu(prev => ({ ...prev, isOpen: false }));\r\n            }\r\n        } else if (e.key === 'Escape') {\r\n            setSlashMenu(prev => ({ ...prev, isOpen: false }));\r\n        }\r\n    }, [slashMenu, editor]);\r\n\r\n    useEffect(() => {\r\n        if (slashMenu.isOpen && slashMenuListRef.current) {\r\n            const activeItem = slashMenuListRef.current.children[slashMenu.selectedIndex];\r\n            if (activeItem) {\r\n                activeItem.scrollIntoView({ block: 'nearest' });\r\n            }\r\n        }\r\n    }, [slashMenu.selectedIndex, slashMenu.isOpen]);\r\n\r\n    useEffect(() => {\r\n        if (tagMenu.isOpen && tagMenuListRef.current) {\r\n            const activeItem = tagMenuListRef.current.children[tagMenu.selectedIndex];\r\n            if (activeItem) {\r\n                activeItem.scrollIntoView({ block: 'nearest' });\r\n            }\r\n        }\r\n    }, [tagMenu.selectedIndex, tagMenu.isOpen]);\r\n\r\n    useEffect(() => {\r\n        const f = nodes.find(n => n.id === fileId);\r\n        if (f) {\r\n            const isInitialLoad = !file || file.id !== fileId;\r\n            // Only update if it's NOT the content we just saved (prevent echo)\r\n            // AND ensure f.content is actually defined (it might be undefined if not yet loaded on-demand)\r\n            const isExternalUpdate = !isInitialLoad &&\r\n                f.content !== undefined &&\r\n                f.content !== (file?.content || '') &&\r\n                f.content !== lastSavedContentRef.current &&\r\n                f.updatedAt > (file?.updatedAt || 0);\r\n\r\n            // Keep file state up to date without necessarily re-loading editor\r\n            setFile(f);\r\n\r\n            if (isInitialLoad || isExternalUpdate) {\r\n                if (isInitialLoad) {\r\n                    setLocalTitle(f.name || '');\r\n                    lastSavedContentRef.current = f.content || ''; // initialize ref\r\n                }\r\n\r\n                if (editor) {\r\n                    const loadContent = async () => {\r\n                        let content = f.content;\r\n                        // On-demand loading: if content is missing from node state, fetch it\r\n                        if (content === undefined) {\r\n                            try {\r\n                                content = await getFileContent(fileId);\r\n                                // Update local state so we don't fetch again\r\n                                setFile(prev => prev?.id === fileId ? { ...prev, content } : prev);\r\n                            } catch (err) {\r\n                                console.error('[Editor] Failed to load file content:', err);\r\n                                return;\r\n                            }\r\n                        }\r\n\r\n                        lastSavedContentRef.current = content || '';\r\n\r\n                        // Ensure task list markers have a space after them for markdown-it-task-lists\r\n                        const preparedContent = (content || '').replace(/^(\\s*-\\s*\\[[ xX]\\])(\\S)/gm, '$1 $2');\r\n                        let html = md.render(preparedContent);\r\n\r\n                        // Convert regular task lists to data-type=\"taskList\" and items to taskItem\r\n                        html = html.replace(/<ul[^>]*class=[\"'][^\"']*task-list[^\"']*[\"'][^>]*>/gi, '<ul data-type=\"taskList\">')\r\n                            .replace(/<li[^>]*class=[\"'][^\"']*task-list-item[^\"']*[\"'][^>]*>/gi, '<li data-type=\"taskItem\">');\r\n\r\n                        // Extract @date and move to attribute, but keep other content clean\r\n                        html = html.replace(/(<li data-type=\"taskItem\"[^>]*>)([\\s\\S]*?)(<\\/li>)/gi, (match, openTag, liContent, closeTag) => {\r\n                            // Support @YYYY-MM-DD or @YYYY-MM-DD HH:MM anywhere in the text\r\n                            // and extract it so it becomes a native Tiptap attribute\r\n                            const dateRegex = /@(\\d{4}-\\d{2}-\\d{2}(?:\\s+\\d{2}:\\d{2})?)/;\r\n                            const dateMatch = liContent.match(dateRegex);\r\n                            if (dateMatch) {\r\n                                const dateStr = dateMatch[1];\r\n                                // Normalise space to T for consistent data-date attribute\r\n                                const isoDate = dateStr.replace(' ', 'T');\r\n                                const cleanedContent = liContent.replace(dateRegex, '').trim();\r\n                                return `${openTag.replace('>', ` data-date=\"${isoDate}\" data-has-date=\"true\" data-has-time=\"${isoDate.includes('T')}\">`)}${cleanedContent}${closeTag}`;\r\n                            }\r\n                            return match;\r\n                        });\r\n\r\n                        const selection = editor.state.selection;\r\n                        editor.commands.setContent(html, false);\r\n\r\n                        if (isExternalUpdate) {\r\n                            try {\r\n                                editor.commands.setTextSelection(selection);\r\n                            } catch (e) { /* ignore */ }\r\n                        }\r\n                    };\r\n                    loadContent();\r\n                }\r\n            }\r\n        }\r\n    }, [fileId, nodes, editor, file?.id]);\r\n\r\n\r\n    if (!file) return null;\r\n\r\n    return (\r\n        <div style={{ display: 'flex', flexDirection: 'column', height: '100%', position: 'relative', minHeight: 0 }}>\r\n            <div className=\"editor-header-bar\">\r\n                <input\r\n                    className=\"title-input\"\r\n                    value={localTitle}\r\n                    onChange={handleTitleChange}\r\n                    placeholder=\"Note Title\"\r\n                />\r\n                <button\r\n                    className=\"icon-button\"\r\n                    onClick={() => {\r\n                        if (window.confirm(\"Delete this note?\")) removeNode(fileId);\r\n                    }}\r\n                    title=\"Delete Note\"\r\n                    style={{ color: 'var(--danger-color)', marginLeft: 'auto' }}\r\n                >\r\n                    <Trash size={18} />\r\n                </button>\r\n            </div>\r\n\r\n            <div className=\"editor-body\" style={{ flex: 1, overflowY: 'auto', padding: '24px', position: 'relative' }} onKeyDownCapture={handleKeyDown}>\r\n                <EditorContent editor={editor} className=\"tiptap-container\" />\r\n\r\n                {/* Table Trigger Button and its Menu */}\r\n                {tableTriggerCoords && (\r\n                    <>\r\n                        <button\r\n                            className=\"table-trigger-btn\"\r\n                            style={{ position: 'fixed', top: tableTriggerCoords.top - 16, left: tableTriggerCoords.right - 28, zIndex: 105 }}\r\n                            onClick={() => setIsTableMenuOpen(!isTableMenuOpen)}\r\n                            title=\"Table Options\"\r\n                        >\r\n                            <MoreHorizontal size={18} />\r\n                        </button>\r\n                        {isTableMenuOpen && <TableControlsMenu editor={editor} trigger={tableTriggerCoords} onClose={() => setIsTableMenuOpen(false)} />}\r\n                    </>\r\n                )}\r\n\r\n                {/* Custom Bubble (Formatting) Menu */}\r\n                {!editor.isActive('table') && <BubbleMenuUI editor={editor} bubbleMenu={bubbleMenu} setBubbleMenu={setBubbleMenu} />}\r\n\r\n                {/* Custom Slash Menu */}\r\n                {slashMenu.isOpen && (\r\n                    <div style={{\r\n                        position: 'fixed',\r\n                        top: slashMenu.top,\r\n                        left: slashMenu.left,\r\n                        backgroundColor: 'var(--bg-secondary)',\r\n                        border: '1px solid var(--border-color)',\r\n                        borderRadius: '8px',\r\n                        boxShadow: 'var(--shadow-md)',\r\n                        zIndex: 1000,\r\n                        minWidth: '200px',\r\n                        padding: '4px',\r\n                        maxHeight: '300px',\r\n                        overflowY: 'auto'\r\n                    }}>\r\n\r\n                        <ul ref={slashMenuListRef} style={{ listStyle: 'none', margin: 0, padding: 0 }}>\r\n                            {SLASH_OPTIONS.filter(o => o.label.toLowerCase().includes(slashMenu.query.toLowerCase())).map((opt, idx) => (\r\n                                <li\r\n                                    key={idx}\r\n                                    onMouseDown={(e) => {\r\n                                        e.preventDefault();\r\n                                        editor.chain().focus().deleteRange({ from: slashMenu.triggerIdx, to: editor.state.selection.from }).run();\r\n                                        opt.command(editor);\r\n                                        setSlashMenu(prev => ({ ...prev, isOpen: false }));\r\n                                    }}\r\n                                    style={{\r\n                                        padding: '8px 12px',\r\n                                        cursor: 'pointer',\r\n                                        borderRadius: '4px',\r\n                                        backgroundColor: idx === slashMenu.selectedIndex ? 'var(--bg-accent)' : 'transparent',\r\n                                        color: idx === slashMenu.selectedIndex ? 'var(--text-primary)' : 'var(--text-secondary)',\r\n                                        fontSize: '14px',\r\n                                        display: 'flex',\r\n                                        alignItems: 'center',\r\n                                        gap: '12px'\r\n                                    }}\r\n                                >\r\n                                    <span style={{ fontSize: '12px', opacity: 0.6, width: '20px', textAlign: 'center' }}>{opt.icon}</span>\r\n                                    {opt.label}\r\n                                </li>\r\n                            ))}\r\n                        </ul>\r\n                    </div>\r\n                )}\r\n\r\n                {/* Custom Tag Menu */}\r\n                {tagMenu.isOpen && (\r\n                    <div style={{\r\n                        position: 'fixed',\r\n                        top: tagMenu.top,\r\n                        left: tagMenu.left,\r\n                        backgroundColor: 'var(--bg-secondary)',\r\n                        border: '1px solid var(--border-color)',\r\n                        borderRadius: '8px',\r\n                        boxShadow: 'var(--shadow-md)',\r\n                        zIndex: 1000,\r\n                        minWidth: '200px',\r\n                        padding: '4px',\r\n                        maxHeight: '200px',\r\n                        overflowY: 'auto'\r\n                    }}>\r\n                        <ul ref={tagMenuListRef} style={{ listStyle: 'none', margin: 0, padding: 0 }}>\r\n                            {availableTags.filter(tag => tag && tag.toLowerCase().includes((tagMenu.query || '').toLowerCase())).map((tag, idx) => (\r\n                                <li\r\n                                    key={idx}\r\n                                    onMouseDown={(e) => {\r\n                                        e.preventDefault();\r\n                                        editor.chain().focus().deleteRange({ from: tagMenu.triggerIdx, to: editor.state.selection.from }).insertContent(`#${tag} `).run();\r\n                                        setTagMenu(prev => ({ ...prev, isOpen: false }));\r\n                                    }}\r\n                                    style={{\r\n                                        padding: '8px 12px',\r\n                                        cursor: 'pointer',\r\n                                        borderRadius: '4px',\r\n                                        backgroundColor: idx === tagMenu.selectedIndex ? 'var(--bg-accent)' : 'transparent',\r\n                                        color: idx === tagMenu.selectedIndex ? 'var(--accent-color)' : 'var(--text-primary)',\r\n                                        fontSize: '14px',\r\n                                        display: 'flex',\r\n                                        alignItems: 'center',\r\n                                        gap: '8px',\r\n                                        fontWeight: 500\r\n                                    }}\r\n                                >\r\n                                    <span style={{ color: 'var(--text-tertiary)' }}>#</span>\r\n                                    {tag}\r\n                                </li>\r\n                            ))}\r\n                            {availableTags.filter(tag => tag && tag.toLowerCase().includes((tagMenu.query || '').toLowerCase())).length === 0 && (\r\n                                <li style={{ padding: '8px 12px', color: 'var(--text-tertiary)', fontSize: '13px', fontStyle: 'italic' }}>\r\n                                    Keep typing to create new tag...\r\n                                </li>\r\n                            )}\r\n                        </ul>\r\n                    </div>\r\n                )}\r\n            </div>\r\n\r\n            <style>{`\r\n                .custom-bubble-menu {\r\n                    display: flex;\r\n                    background: var(--bg-secondary);\r\n                    padding: 4px;\r\n                    border-radius: 8px;\r\n                    border: 1px solid var(--border-color);\r\n                    box-shadow: var(--shadow-md);\r\n                    gap: 2px;\r\n                    backdrop-filter: blur(8px);\r\n                }\r\n                .custom-bubble-menu button {\r\n                    background: transparent;\r\n                    border: none;\r\n                    border-radius: 4px;\r\n                    padding: 6px;\r\n                    color: var(--text-secondary);\r\n                    cursor: pointer;\r\n                    display: flex;\r\n                    align-items: center;\r\n                    justify-content: center;\r\n                }\r\n                .custom-bubble-menu button.is-active {\r\n                    background: var(--accent-color);\r\n                    color: white;\r\n                }\r\n                .menu-separator {\r\n                    width: 1px;\r\n                    height: 20px;\r\n                    background: var(--border-color);\r\n                    align-self: center;\r\n                    margin: 0 4px;\r\n                }\r\n                .table-controls-enhanced {\r\n                    display: flex;\r\n                    flex-direction: row;\r\n                    padding: 8px;\r\n                    gap: 12px;\r\n                }\r\n                .table-controls-group {\r\n                    display: flex;\r\n                    flex-direction: column;\r\n                    gap: 4px;\r\n                }\r\n                .table-controls-group button {\r\n                    justify-content: flex-start;\r\n                    gap: 8px;\r\n                    padding: 6px 12px;\r\n                    width: 100%;\r\n                    font-size: 13px;\r\n                }\r\n                .table-controls-group button:hover {\r\n                    background: var(--bg-hover);\r\n                }\r\n                .menu-separator-vertical {\r\n                    width: 1px;\r\n                    background: var(--border-color);\r\n                    align-self: stretch;\r\n                }\r\n                button.danger-btn {\r\n                    color: var(--danger-color) !important;\r\n                }\r\n                button.danger-btn:hover {\r\n                    background: rgba(239, 68, 68, 0.1) !important;\r\n                }\r\n                .title-input {\r\n                    background: transparent;\r\n                    border: none;\r\n                    outline: none;\r\n                    font-size: 24px;\r\n                    font-weight: bold;\r\n                    color: var(--text-primary);\r\n                    width: 100%;\r\n                }\r\n                .tiptap-container {\r\n                    user-select: text !important;\r\n                    -webkit-user-select: text !important;\r\n                    outline: none;\r\n                }\r\n                .editor-link {\r\n                    color: var(--accent-color);\r\n                    text-decoration: underline;\r\n                    cursor: pointer;\r\n                }\r\n                .editor-link:hover {\r\n                    opacity: 0.8;\r\n                }\r\n                .table-trigger-btn {\r\n                    background: var(--bg-secondary);\r\n                    border: 1px solid var(--border-color);\r\n                    border-radius: 6px;\r\n                    padding: 4px;\r\n                    cursor: pointer;\r\n                    display: flex;\r\n                    align-items: center;\r\n                    justify-content: center;\r\n                    color: var(--text-secondary);\r\n                    box-shadow: var(--shadow-sm);\r\n                    transition: all 0.2s;\r\n                }\r\n                .table-trigger-btn:hover {\r\n                    background: var(--bg-hover);\r\n                    color: var(--text-primary);\r\n                    border-color: var(--text-tertiary);\r\n                }\r\n            `}</style>\r\n        </div>\r\n    );\r\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jonat\\Downloads\\redly\\src\\components\\FileTree.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jonat\\Downloads\\redly\\src\\components\\GlobalSearch.jsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n  40 |     useEffect(() => {\n  41 |         if (query.trim().length < 2) {\n> 42 |             setResults([]);\n     |             ^^^^^^^^^^ Avoid calling setState() directly within an effect\n  43 |             setIsOpen(false);\n  44 |             return;\n  45 |         }","line":42,"column":13,"nodeType":null,"endLine":42,"endColumn":23}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect, useRef } from 'react';\r\nimport { Search, FileText, X } from 'lucide-react';\r\nimport { useNotes } from '../context/NotesContext';\r\nimport { getFileContent } from '../lib/db';\r\n\r\nexport default function GlobalSearch() {\r\n    const { nodes, setActiveFileId } = useNotes();\r\n    const [query, setQuery] = useState('');\r\n    const [results, setResults] = useState([]);\r\n    const [isOpen, setIsOpen] = useState(false);\r\n    const [selectedIndex, setSelectedIndex] = useState(0);\r\n    const [isSearching, setIsSearching] = useState(false);\r\n    const containerRef = useRef(null);\r\n    const inputRef = useRef(null);\r\n\r\n    // Global focus shortcut (Alt + K)\r\n    useEffect(() => {\r\n        const handleGlobalKeyDown = (e) => {\r\n            if (e.altKey && e.key.toLowerCase() === 'k') {\r\n                e.preventDefault();\r\n                inputRef.current?.focus();\r\n            }\r\n        };\r\n        window.addEventListener('keydown', handleGlobalKeyDown);\r\n        return () => window.removeEventListener('keydown', handleGlobalKeyDown);\r\n    }, []);\r\n\r\n    // Handle clicks outside to close dropdown\r\n    useEffect(() => {\r\n        const handleClickOutside = (e) => {\r\n            if (containerRef.current && !containerRef.current.contains(e.target)) {\r\n                setIsOpen(false);\r\n            }\r\n        };\r\n        document.addEventListener('mousedown', handleClickOutside);\r\n        return () => document.removeEventListener('mousedown', handleClickOutside);\r\n    }, []);\r\n\r\n    // Perform search\r\n    useEffect(() => {\r\n        if (query.trim().length < 2) {\r\n            setResults([]);\r\n            setIsOpen(false);\r\n            return;\r\n        }\r\n\r\n        const performSearch = async () => {\r\n            setIsSearching(true);\r\n            const lowerQuery = query.toLowerCase();\r\n            const searchResults = [];\r\n\r\n            // Files only\r\n            const fileNodes = nodes.filter(n => n.type === 'file');\r\n\r\n            for (const node of fileNodes) {\r\n                const nameMatch = node.name.toLowerCase().includes(lowerQuery);\r\n                let contentSnippet = null;\r\n\r\n                try {\r\n                    const content = await getFileContent(node.id);\r\n                    if (content) {\r\n                        const lowerContent = content.toLowerCase();\r\n                        const contentIndex = lowerContent.indexOf(lowerQuery);\r\n                        if (contentIndex !== -1) {\r\n                            // Extract snippet\r\n                            const start = Math.max(0, contentIndex - 30);\r\n                            const end = Math.min(content.length, contentIndex + lowerQuery.length + 30);\r\n                            let snippet = content.substring(start, end).replace(/\\n/g, ' ');\r\n                            if (start > 0) snippet = '...' + snippet;\r\n                            if (end < content.length) snippet = snippet + '...';\r\n                            contentSnippet = snippet;\r\n                        }\r\n                    }\r\n                } catch (e) {\r\n                    console.error('Header search failed for:', node.id, e);\r\n                }\r\n\r\n                if (nameMatch || contentSnippet) {\r\n                    searchResults.push({\r\n                        ...node,\r\n                        nameMatch,\r\n                        contentSnippet\r\n                    });\r\n                }\r\n            }\r\n\r\n            // Sort: Name matches first\r\n            searchResults.sort((a, b) => {\r\n                if (a.nameMatch && !b.nameMatch) return -1;\r\n                if (!a.nameMatch && b.nameMatch) return 1;\r\n                return a.name.localeCompare(b.name);\r\n            });\r\n\r\n            setResults(searchResults.slice(0, 10)); // Limit Results in dropdown\r\n            setSelectedIndex(0);\r\n            setIsSearching(false);\r\n            setIsOpen(true);\r\n        };\r\n\r\n        const timeoutId = setTimeout(performSearch, 250);\r\n        return () => clearTimeout(timeoutId);\r\n    }, [query, nodes]);\r\n\r\n    const handleKeyDown = (e) => {\r\n        if (e.key === 'ArrowDown') {\r\n            e.preventDefault();\r\n            setSelectedIndex(prev => (prev + 1) % Math.max(1, results.length));\r\n        } else if (e.key === 'ArrowUp') {\r\n            e.preventDefault();\r\n            setSelectedIndex(prev => (prev - 1 + results.length) % Math.max(1, results.length));\r\n        } else if (e.key === 'Enter' && results[selectedIndex]) {\r\n            e.preventDefault();\r\n            handleSelect(results[selectedIndex]);\r\n        } else if (e.key === 'Escape') {\r\n            setIsOpen(false);\r\n            inputRef.current?.blur();\r\n        }\r\n    };\r\n\r\n    const handleSelect = (node) => {\r\n        setActiveFileId(node.id);\r\n        setIsOpen(false);\r\n        setQuery('');\r\n        inputRef.current?.blur();\r\n    };\r\n\r\n    return (\r\n        <div ref={containerRef} className=\"global-search-container\" style={{ position: 'relative', flex: 1, maxWidth: '400px', margin: '0 16px' }}>\r\n            <div style={{\r\n                display: 'flex',\r\n                alignItems: 'center',\r\n                background: 'var(--bg-secondary)',\r\n                borderRadius: '10px',\r\n                padding: '4px 12px',\r\n                border: '1px solid var(--border-color)',\r\n                transition: 'all 0.2s ease',\r\n                boxShadow: isOpen ? '0 0 0 2px var(--accent-color-alpha)' : 'none',\r\n                borderColor: isOpen ? 'var(--accent-color)' : 'var(--border-color)'\r\n            }}>\r\n                <Search size={16} style={{ color: 'var(--text-tertiary)', marginRight: '8px' }} />\r\n                <input\r\n                    ref={inputRef}\r\n                    className=\"global-search-input\"\r\n                    value={query}\r\n                    onChange={e => setQuery(e.target.value)}\r\n                    onKeyDown={handleKeyDown}\r\n                    onFocus={() => query.length >= 2 && setIsOpen(true)}\r\n                    placeholder=\"Search notes... (Alt + K)\"\r\n                    style={{\r\n                        flex: 1,\r\n                        background: 'transparent',\r\n                        border: 'none',\r\n                        color: 'var(--text-primary)',\r\n                        outline: 'none',\r\n                        height: '32px',\r\n                        fontSize: '14px'\r\n                    }}\r\n                />\r\n                {query && (\r\n                    <button\r\n                        onClick={() => { setQuery(''); setResults([]); setIsOpen(false); inputRef.current?.focus(); }}\r\n                        style={{ background: 'transparent', border: 'none', color: 'var(--text-tertiary)', cursor: 'pointer', padding: '4px', display: 'flex' }}\r\n                    >\r\n                        <X size={14} />\r\n                    </button>\r\n                )}\r\n                {isSearching && (\r\n                    <div className=\"search-spinner-tiny\" style={{\r\n                        width: '12px',\r\n                        height: '12px',\r\n                        border: '2px solid var(--border-color)',\r\n                        borderTopColor: 'var(--accent-color)',\r\n                        borderRadius: '50%',\r\n                        animation: 'spin-fast 0.6s linear infinite',\r\n                        marginLeft: '4px'\r\n                    }} />\r\n                )}\r\n            </div>\r\n\r\n            {isOpen && results.length > 0 && (\r\n                <div\r\n                    className=\"search-dropdown-results\"\r\n                    style={{\r\n                        position: 'absolute',\r\n                        top: 'calc(100% + 8px)',\r\n                        left: 0,\r\n                        right: 0,\r\n                        background: 'var(--bg-primary)',\r\n                        border: '1px solid var(--border-color)',\r\n                        borderRadius: '10px',\r\n                        boxShadow: '0 10px 30px rgba(0,0,0,0.15)',\r\n                        zIndex: 1000,\r\n                        overflow: 'hidden',\r\n                        padding: '4px'\r\n                    }}\r\n                >\r\n                    {results.map((res, i) => (\r\n                        <div\r\n                            key={res.id}\r\n                            onClick={() => handleSelect(res)}\r\n                            onMouseEnter={() => setSelectedIndex(i)}\r\n                            style={{\r\n                                padding: '10px 12px',\r\n                                borderRadius: '6px',\r\n                                cursor: 'pointer',\r\n                                background: i === selectedIndex ? 'var(--bg-secondary)' : 'transparent',\r\n                                display: 'flex',\r\n                                flexDirection: 'column',\r\n                                gap: '2px',\r\n                                borderLeft: i === selectedIndex ? '3px solid var(--accent-color)' : '3px solid transparent',\r\n                                transition: 'background 0.1s ease'\r\n                            }}\r\n                        >\r\n                            <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>\r\n                                <FileText size={14} style={{ color: res.nameMatch ? 'var(--accent-color)' : 'var(--text-tertiary)' }} />\r\n                                <span style={{\r\n                                    fontSize: '14px',\r\n                                    fontWeight: res.nameMatch ? '600' : '400',\r\n                                    color: 'var(--text-primary)',\r\n                                    whiteSpace: 'nowrap',\r\n                                    overflow: 'hidden',\r\n                                    textOverflow: 'ellipsis'\r\n                                }}>\r\n                                    {res.name}\r\n                                </span>\r\n                                <span style={{ fontSize: '11px', color: 'var(--text-tertiary)', marginLeft: 'auto', opacity: 0.7 }}>\r\n                                    {res.parentId || 'root'}\r\n                                </span>\r\n                            </div>\r\n                            {res.contentSnippet && (\r\n                                <div style={{\r\n                                    fontSize: '12px',\r\n                                    color: 'var(--text-tertiary)',\r\n                                    marginLeft: '22px',\r\n                                    fontStyle: 'italic',\r\n                                    display: '-webkit-box',\r\n                                    WebkitLineClamp: 1,\r\n                                    WebkitBoxOrient: 'vertical',\r\n                                    overflow: 'hidden'\r\n                                }}>\r\n                                    {res.contentSnippet}\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n                    ))}\r\n                    <div style={{ padding: '8px 12px', borderTop: '1px solid var(--border-color)', fontSize: '11px', color: 'var(--text-tertiary)', display: 'flex', gap: '10px' }}>\r\n                        <span><kbd>Enter</kbd> to open</span>\r\n                        <span><kbd>ÔåæÔåô</kbd> to move</span>\r\n                    </div>\r\n                </div>\r\n            )}\r\n\r\n            <style>{`\r\n                @keyframes spin-fast {\r\n                    to { transform: rotate(360deg); }\r\n                }\r\n                .global-search-input::placeholder {\r\n                    color: var(--text-tertiary);\r\n                    opacity: 0.6;\r\n                }\r\n                kbd {\r\n                    background: var(--bg-secondary);\r\n                    padding: 2px 4px;\r\n                    border-radius: 4px;\r\n                    border: 1px solid var(--border-color);\r\n                }\r\n            `}</style>\r\n        </div>\r\n    );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jonat\\Downloads\\redly\\src\\components\\GlobalTasks.jsx","messages":[{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\-.","line":172,"column":52,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":172,"endColumn":53,"suggestions":[{"messageId":"removeEscape","fix":{"range":[6856,6857],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[6856,6856],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useMemo, useState, useEffect, useRef } from 'react';\r\nimport { CheckSquare, Square, Folder, FileText, ChevronRight, LayoutList, Columns, Tag } from 'lucide-react';\r\nimport { DragDropContext, Droppable, Draggable } from '@hello-pangea/dnd';\r\nimport { useNotes } from '../context/NotesContext';\r\nimport { parseTasksFromNodes } from '../utils/taskParser';\r\nimport { getDateColor } from '../utils/dateHelpers';\r\nimport InlineDateInput from './InlineDateInput';\r\n\r\nexport default function GlobalTasks() {\r\n    const { nodes, openAndExpandFile, editNode, ensureAllContentsLoaded } = useNotes();\r\n    const [isLoading, setIsLoading] = useState(true);\r\n    const [viewMode, setViewMode] = useState('list'); // 'list' or 'kanban'\r\n    const [selectedTagFilter, setSelectedTagFilter] = useState('');\r\n\r\n    const tagFilterRef = useRef(null);\r\n\r\n    useEffect(() => {\r\n        const load = async () => {\r\n            await ensureAllContentsLoaded();\r\n            setIsLoading(false);\r\n        };\r\n        load();\r\n\r\n        const handleKeyDown = (e) => {\r\n            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.closest('.ProseMirror')) {\r\n                return;\r\n            }\r\n            if (e.altKey && !e.shiftKey && e.key.toLowerCase() === 'v') {\r\n                e.preventDefault();\r\n                setViewMode(prev => prev === 'list' ? 'kanban' : 'list');\r\n            }\r\n            if (e.altKey && !e.shiftKey && e.key.toLowerCase() === 'g') {\r\n                e.preventDefault();\r\n                if (tagFilterRef.current) {\r\n                    tagFilterRef.current.focus();\r\n                }\r\n            }\r\n        };\r\n\r\n        window.addEventListener('keydown', handleKeyDown);\r\n        return () => window.removeEventListener('keydown', handleKeyDown);\r\n    }, [ensureAllContentsLoaded]);\r\n\r\n    const sortedTasks = useMemo(() => {\r\n        const parsedTasks = parseTasksFromNodes(nodes);\r\n        return parsedTasks.sort((a, b) => {\r\n            const getUrgency = (task) => {\r\n                if (!task.date) return 4;\r\n                const color = getDateColor(task.date, task.hasTime);\r\n                if (color === 'var(--color-overdue)') return 1;\r\n                if (color === 'var(--color-today)') return 2;\r\n                if (color === 'var(--color-future)') return 3;\r\n                return 4;\r\n            };\r\n\r\n            const urgencyA = getUrgency(a);\r\n            const urgencyB = getUrgency(b);\r\n\r\n            // 1. Sort by Urgency (Red -> Orange -> Green -> None)\r\n            if (urgencyA !== urgencyB) {\r\n                return urgencyA - urgencyB;\r\n            }\r\n\r\n            // 2. If same urgency, sort chronologically\r\n            if (a.date && b.date) {\r\n                const dateA = new Date(a.date).getTime();\r\n                const dateB = new Date(b.date).getTime();\r\n                if (dateA !== dateB) return dateA - dateB;\r\n            }\r\n\r\n            // 3. Secondary sort: Alphabetical by task text\r\n            const textA = (a.text || '').trim().toLowerCase();\r\n            const textB = (b.text || '').trim().toLowerCase();\r\n            return textA.localeCompare(textB);\r\n        });\r\n    }, [nodes]);\r\n\r\n    const allAvailableTags = useMemo(() => {\r\n        const tagSet = new Set();\r\n        sortedTasks.forEach(t => {\r\n            if (t.tags && t.tags.length > 0) {\r\n                t.tags.forEach(tag => tagSet.add(tag));\r\n            }\r\n        });\r\n        return Array.from(tagSet).sort();\r\n    }, [sortedTasks]);\r\n\r\n    const filteredTasks = useMemo(() => {\r\n        if (!selectedTagFilter) return sortedTasks;\r\n        return sortedTasks.filter(t => t.tags && t.tags.includes(selectedTagFilter));\r\n    }, [sortedTasks, selectedTagFilter]);\r\n\r\n    const pendingTasks = filteredTasks.filter(t => !t.checked);\r\n    const completedTasks = filteredTasks.filter(t => t.checked);\r\n\r\n    const handleToggle = async (e, task) => {\r\n        e.stopPropagation();\r\n        const file = nodes.find(n => n.id === task.fileId);\r\n        if (!file || !file.content) return;\r\n\r\n        const lines = file.content.split('\\n');\r\n        const taskLine = lines[task.lineIndex];\r\n\r\n        if (taskLine) {\r\n            // Toggle [ ] <-> [x]\r\n            if (taskLine.includes('- [ ]')) {\r\n                lines[task.lineIndex] = taskLine.replace('- [ ]', '- [x]');\r\n            } else if (taskLine.includes('- [x]')) {\r\n                lines[task.lineIndex] = taskLine.replace('- [x]', '- [ ]');\r\n            }\r\n\r\n            await editNode(task.fileId, { content: lines.join('\\n') });\r\n        }\r\n    };\r\n\r\n    const handleDateUpdate = async (task, newDateString, newHasTime) => {\r\n        const file = nodes.find(n => n.id === task.fileId);\r\n        if (!file || !file.content) return;\r\n\r\n        const lines = file.content.split('\\n');\r\n        let taskLine = lines[task.lineIndex];\r\n\r\n        if (taskLine) {\r\n            // Remove existing @date pattern (robust version)\r\n            taskLine = taskLine.replace(/\\s*@\\d{4}-\\d{2}-\\d{2}(\\s+\\d{2}:\\d{2})?/, '');\r\n\r\n            // Add new @date if provided\r\n            if (newDateString) {\r\n                const [datePart, timePart] = newDateString.split('T');\r\n                const formattedDate = newHasTime && timePart\r\n                    ? `${datePart} ${timePart.substring(0, 5)}`\r\n                    : datePart;\r\n                taskLine = `${taskLine.trimEnd()} @${formattedDate}`;\r\n            }\r\n\r\n            lines[task.lineIndex] = taskLine;\r\n            await editNode(task.fileId, { content: lines.join('\\n') });\r\n        }\r\n    };\r\n\r\n\r\n\r\n    const columns = useMemo(() => {\r\n        const allColumns = new Set(['backlog', 'todo', 'doing', 'review', 'done']);\r\n        filteredTasks.forEach(t => {\r\n            if (t.column && t.column.trim() !== '') allColumns.add(t.column.toLowerCase());\r\n        });\r\n        const colArray = Array.from(allColumns).filter(c => c !== 'done');\r\n        if (allColumns.has('done')) colArray.push('done');\r\n        return colArray;\r\n    }, [filteredTasks]);\r\n\r\n    const onDragEnd = async (result) => {\r\n        const { destination, source, draggableId } = result;\r\n        if (!destination) return;\r\n        if (destination.droppableId === source.droppableId && destination.index === source.index) return;\r\n\r\n        const task = sortedTasks.find(t => t.id === draggableId);\r\n        if (!task) return;\r\n\r\n        const newColumn = destination.droppableId;\r\n        const targetColumnTag = `#${newColumn}`;\r\n\r\n        const file = nodes.find(n => n.id === task.fileId);\r\n        if (!file || !file.content) return;\r\n\r\n        const lines = file.content.split('\\n');\r\n        let taskLine = lines[task.lineIndex];\r\n\r\n        if (taskLine) {\r\n            // Find the last hashtag in the text to replace it\r\n            const tagRegex = /(?:^|\\s)#([a-zA-Z0-9_\\-]+)/g;\r\n            let tagMatch;\r\n            let lastTagMatch = null;\r\n            while ((tagMatch = tagRegex.exec(taskLine)) !== null) {\r\n                lastTagMatch = tagMatch;\r\n            }\r\n\r\n            if (lastTagMatch && lastTagMatch[1].toLowerCase() === task.column) {\r\n                // Task had an explicit tag, replace it\r\n                taskLine = taskLine.substring(0, lastTagMatch.index) + taskLine.substring(lastTagMatch.index).replace(lastTagMatch[0], ` ${targetColumnTag}`);\r\n            } else {\r\n                // Task had no explicit tag (defaulted column), append it\r\n                taskLine = taskLine.trimEnd() + ` ${targetColumnTag}`;\r\n            }\r\n\r\n            // Sync visual checkbox state with 'done' vs 'todo/doing'\r\n            if (newColumn === 'done' && taskLine.includes('- [ ]')) {\r\n                taskLine = taskLine.replace('- [ ]', '- [x]');\r\n            } else if (newColumn !== 'done' && taskLine.includes('- [x]')) {\r\n                taskLine = taskLine.replace('- [x]', '- [ ]');\r\n            }\r\n\r\n            lines[task.lineIndex] = taskLine;\r\n            await editNode(task.fileId, { content: lines.join('\\n') });\r\n        }\r\n    };\r\n\r\n    const TaskItem = ({ task }) => (\r\n        <div\r\n            className=\"global-task-item\"\r\n            style={{\r\n                display: 'flex', alignItems: 'flex-start', gap: '12px', padding: '12px 16px',\r\n                borderBottom: '1px solid var(--border-color)', cursor: 'pointer',\r\n                transition: 'background 0.2s'\r\n            }}\r\n            onClick={() => openAndExpandFile(task.fileId)}\r\n        >\r\n            <div\r\n                onClick={(e) => handleToggle(e, task)}\r\n                style={{\r\n                    color: task.checked ? 'var(--text-tertiary)' : (task.date ? getDateColor(task.date, task.hasTime) : 'var(--accent-color)'),\r\n                    marginTop: '2px',\r\n                    cursor: 'pointer'\r\n                }}\r\n                title=\"Toggle Task\"\r\n            >\r\n\r\n                {task.checked ? <CheckSquare size={18} /> : <Square size={18} />}\r\n            </div>\r\n\r\n            <div style={{ flex: 1 }}>\r\n                <div style={{\r\n                    fontSize: '15px', color: task.checked ? 'var(--text-tertiary)' : 'var(--text-primary)',\r\n                    textDecoration: task.checked ? 'line-through' : 'none',\r\n                    lineHeight: '1.4', marginBottom: '4px',\r\n                    display: 'flex', flexWrap: 'wrap', alignItems: 'center', gap: '6px'\r\n                }}>\r\n                    <span>{task.text || <em>Empty task</em>}</span>\r\n                    {task.tags && task.tags.length > 0 && task.tags.map(tag => (\r\n                        <span key={tag} style={{\r\n                            background: 'var(--bg-secondary)',\r\n                            color: 'var(--accent-color)',\r\n                            border: '1px solid var(--border-color)',\r\n                            padding: '1px 8px',\r\n                            borderRadius: '12px',\r\n                            fontSize: '11px',\r\n                            fontWeight: '600',\r\n                            textDecoration: 'none'\r\n                        }}>\r\n                            #{tag}\r\n                        </span>\r\n                    ))}\r\n                </div>\r\n\r\n                <div style={{ display: 'flex', alignItems: 'center', gap: '6px', fontSize: '12px', color: 'var(--text-tertiary)' }}>\r\n                    {task.path.map((segment, idx) => (\r\n                        <React.Fragment key={idx}>\r\n                            <span style={{\r\n                                display: 'flex',\r\n                                alignItems: 'center',\r\n                                gap: '4px',\r\n                                color: task.checked ? 'var(--text-tertiary)' : (idx === task.path.length - 1 && task.date ? getDateColor(task.date, task.hasTime) : 'inherit')\r\n                            }}>\r\n                                {idx === task.path.length - 1 ? <FileText size={12} /> : <Folder size={12} />}\r\n                                {segment}\r\n                            </span>\r\n\r\n                            {idx < task.path.length - 1 && <ChevronRight size={12} style={{ opacity: 0.5 }} />}\r\n                        </React.Fragment>\r\n                    ))}\r\n\r\n                    {task.date && (\r\n                        <div style={{ marginLeft: '8px', zIndex: 10 }}>\r\n                            <InlineDateInput\r\n                                initialDate={task.date instanceof Date ? task.date.toISOString() : task.date}\r\n                                initialHasTime={task.hasTime === true || task.hasTime === 'true'}\r\n                                isChecked={task.checked}\r\n                                onDateChange={(newDateStr, newHasTime) => handleDateUpdate(task, newDateStr, newHasTime)}\r\n                                onClearDate={() => handleDateUpdate(task, null, false)}\r\n                            />\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n\r\n    return (\r\n        <div style={{ height: '100%', display: 'flex', flexDirection: 'column', backgroundColor: 'var(--bg-primary)' }}>\r\n            <div style={{ padding: '24px', borderBottom: '1px solid var(--border-color)', display: 'flex', flexDirection: 'column', gap: '8px', flexShrink: 0 }}>\r\n                <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', width: '100%' }}>\r\n                    <div>\r\n                        <h1 style={{ margin: 0, fontSize: '24px', display: 'flex', alignItems: 'center', gap: '12px', color: 'var(--text-primary)' }}>\r\n                            <CheckSquare size={28} style={{ color: 'var(--accent-color)' }} />\r\n                            Tasks Overview\r\n                        </h1>\r\n                        <p style={{ margin: 0, color: 'var(--text-secondary)', fontSize: '14px', marginTop: '4px' }}>\r\n                            Manage all your Todo items across your knowledge base.\r\n                        </p>\r\n                    </div>\r\n\r\n                    {/* View Toggle and Filter */}\r\n                    <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>\r\n                        {allAvailableTags.length > 0 && (\r\n                            <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>\r\n                                <Tag size={16} style={{ color: 'var(--text-tertiary)' }} />\r\n                                <select\r\n                                    ref={tagFilterRef}\r\n                                    value={selectedTagFilter}\r\n                                    onChange={(e) => setSelectedTagFilter(e.target.value)}\r\n                                    className=\"tag-filter-select\"\r\n                                    style={{\r\n                                        background: 'var(--bg-secondary)',\r\n                                        color: 'var(--text-primary)',\r\n                                        border: '1px solid var(--border-color)',\r\n                                        borderRadius: '6px',\r\n                                        padding: '4px 8px',\r\n                                        fontSize: '13px',\r\n                                        cursor: 'pointer',\r\n                                        outline: 'none'\r\n                                    }}\r\n                                >\r\n                                    <option value=\"\">All Tags</option>\r\n                                    {allAvailableTags.map(tag => (\r\n                                        <option key={tag} value={tag}>#{tag}</option>\r\n                                    ))}\r\n                                </select>\r\n                            </div>\r\n                        )}\r\n                        <div style={{ display: 'flex', background: 'var(--bg-secondary)', padding: '4px', borderRadius: '8px', border: '1px solid var(--border-color)' }}>\r\n                            <button\r\n                                onClick={() => setViewMode('list')}\r\n                                style={{\r\n                                    display: 'flex', alignItems: 'center', gap: '6px', padding: '6px 12px', borderRadius: '4px', border: 'none', cursor: 'pointer',\r\n                                    fontSize: '13px', fontWeight: 'bold', transition: 'all 0.2s',\r\n                                    background: viewMode === 'list' ? 'var(--bg-accent)' : 'transparent',\r\n                                    color: viewMode === 'list' ? 'var(--accent-color)' : 'var(--text-secondary)'\r\n                                }}\r\n                            >\r\n                                <LayoutList size={16} /> List\r\n                            </button>\r\n                            <button\r\n                                onClick={() => setViewMode('kanban')}\r\n                                style={{\r\n                                    display: 'flex', alignItems: 'center', gap: '6px', padding: '6px 12px', borderRadius: '4px', border: 'none', cursor: 'pointer',\r\n                                    fontSize: '13px', fontWeight: 'bold', transition: 'all 0.2s',\r\n                                    background: viewMode === 'kanban' ? 'var(--bg-accent)' : 'transparent',\r\n                                    color: viewMode === 'kanban' ? 'var(--accent-color)' : 'var(--text-secondary)'\r\n                                }}\r\n                            >\r\n                                <Columns size={16} /> Board\r\n                            </button>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            <div style={{ flex: 1, overflowY: 'auto', padding: viewMode === 'kanban' ? '0 24px' : '0 24px 24px 24px', display: 'flex', flexDirection: 'column' }}>\r\n                <div style={{ maxWidth: '800px', margin: '0 auto', paddingTop: '24px' }}>\r\n\r\n                    {isLoading ? (\r\n                        <div style={{ textAlign: 'center', padding: '48px', color: 'var(--text-tertiary)' }}>\r\n                            <div className=\"loading-spinner\" style={{ marginBottom: '16px' }}>\r\n                                <CheckSquare size={48} style={{ opacity: 0.2, animation: 'pulse 1.5s infinite' }} />\r\n                            </div>\r\n                            <p>Scanning all notes for tasks...</p>\r\n                            <style>{`\r\n                                @keyframes pulse {\r\n                                    0% { transform: scale(0.95); opacity: 0.2; }\r\n                                    50% { transform: scale(1.05); opacity: 0.5; }\r\n                                    100% { transform: scale(0.95); opacity: 0.2; }\r\n                                }\r\n                            `}</style>\r\n                        </div>\r\n                    ) : pendingTasks.length === 0 && completedTasks.length === 0 ? (\r\n                        <div style={{ textAlign: 'center', padding: '48px', color: 'var(--text-tertiary)' }}>\r\n                            <CheckSquare size={48} style={{ opacity: 0.2, marginBottom: '16px' }} />\r\n                            <p>You don't have any tasks right now.</p>\r\n                            <p style={{ fontSize: '13px' }}>Type `/` in any note and select \"Todo List\" to create one.</p>\r\n                        </div>\r\n                    ) : viewMode === 'list' ? (\r\n                        <div style={{ maxWidth: '800px', margin: '0 auto', paddingTop: '24px' }}>\r\n                            <div style={{ marginBottom: '32px' }}>\r\n                                <h3 style={{ fontSize: '14px', textTransform: 'uppercase', letterSpacing: '1px', color: 'var(--accent-color)', borderBottom: '1px solid var(--border-color)', paddingBottom: '8px', marginBottom: '0' }}>\r\n                                    Pending Actions ({pendingTasks.length})\r\n                                </h3>\r\n                                <div>\r\n                                    {pendingTasks.map(task => <TaskItem key={task.id} task={task} />)}\r\n                                </div>\r\n                            </div>\r\n\r\n                            {completedTasks.length > 0 && (\r\n                                <div style={{ opacity: 0.7 }}>\r\n                                    <h3 style={{ fontSize: '14px', textTransform: 'uppercase', letterSpacing: '1px', color: 'var(--text-tertiary)', borderBottom: '1px solid var(--border-color)', paddingBottom: '8px', marginBottom: '0' }}>\r\n                                        Completed ({completedTasks.length})\r\n                                    </h3>\r\n                                    <div>\r\n                                        {completedTasks.map(task => <TaskItem key={task.id} task={task} />)}\r\n                                    </div>\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n                    ) : (\r\n                        <DragDropContext onDragEnd={onDragEnd}>\r\n                            <div className=\"kanban-board-scroll\" style={{ display: 'flex', gap: '24px', padding: '12px 4px 24px 4px', overflowX: 'auto', flex: 1, height: '100%', alignItems: 'flex-start' }}>\r\n                                {columns.map(col => {\r\n                                    const colTasks = filteredTasks.filter(t => t.column === col);\r\n                                    return (\r\n                                        <div key={col} className=\"kanban-column\" style={{ minWidth: '275px', width: '275px', borderRadius: '12px', display: 'flex', flexDirection: 'column', maxHeight: '100%', overflow: 'hidden' }}>\r\n                                            <div style={{ padding: '14px 16px', borderBottom: '1px solid var(--border-color)', fontWeight: 'bold', display: 'flex', justifyContent: 'space-between', alignItems: 'center', background: 'var(--bg-secondary)' }}>\r\n                                                <span style={{ textTransform: 'uppercase', fontSize: '13px', letterSpacing: '0.05em', color: 'var(--text-primary)' }}>#{col}</span>\r\n                                                <span style={{ fontSize: '12px', background: 'var(--bg-primary)', color: 'var(--text-secondary)', padding: '2px 10px', borderRadius: '12px', border: '1px solid var(--border-color)', fontWeight: '600' }}>{colTasks.length}</span>\r\n                                            </div>\r\n                                            <Droppable droppableId={col}>\r\n                                                {(provided, snapshot) => (\r\n                                                    <div ref={provided.innerRef} {...provided.droppableProps} style={{ padding: '12px', flex: 1, overflowY: 'auto', minHeight: '150px', display: 'flex', flexDirection: 'column', gap: '10px', background: snapshot.isDraggingOver ? 'var(--bg-hover)' : 'transparent', transition: 'background 0.2s', borderBottomLeftRadius: '12px', borderBottomRightRadius: '12px' }}>\r\n                                                        {colTasks.map((task, index) => (\r\n                                                            <Draggable key={task.id} draggableId={task.id} index={index}>\r\n                                                                {(provided, snapshot) => (\r\n                                                                    <div\r\n                                                                        ref={provided.innerRef}\r\n                                                                        {...provided.draggableProps}\r\n                                                                        {...provided.dragHandleProps}\r\n                                                                        className=\"kanban-card\"\r\n                                                                        style={{\r\n                                                                            ...provided.draggableProps.style,\r\n                                                                            background: 'var(--bg-primary)',\r\n                                                                            border: '1px solid var(--border-color)',\r\n                                                                            borderRadius: '8px',\r\n                                                                            padding: '14px',\r\n                                                                            boxShadow: snapshot.isDragging ? 'var(--shadow-md)' : 'var(--shadow-sm)',\r\n                                                                            opacity: snapshot.isDragging ? 0.95 : 1,\r\n                                                                            userSelect: 'none',\r\n                                                                            display: 'flex',\r\n                                                                            flexDirection: 'column',\r\n                                                                            gap: '6px'\r\n                                                                        }}\r\n                                                                        onClick={(e) => {\r\n                                                                            if (e.target.tagName.toLowerCase() === 'input') return;\r\n                                                                            openAndExpandFile(task.fileId);\r\n                                                                        }}\r\n                                                                    >\r\n                                                                        <div style={{ display: 'flex', alignItems: 'flex-start', gap: '10px' }}>\r\n                                                                            <div onClick={(e) => handleToggle(e, task)} style={{ color: task.checked ? 'var(--text-tertiary)' : (task.date ? getDateColor(task.date, task.hasTime) : 'var(--accent-color)'), cursor: 'pointer', marginTop: '1px' }}>\r\n                                                                                {task.checked ? <CheckSquare size={18} /> : <Square size={18} />}\r\n                                                                            </div>\r\n                                                                            <div style={{ flex: 1, fontSize: '14.5px', color: task.checked ? 'var(--text-tertiary)' : 'var(--text-primary)', textDecoration: task.checked ? 'line-through' : 'none', lineHeight: '1.4', fontWeight: task.checked ? '400' : '500' }}>\r\n                                                                                <div style={{ marginBottom: '4px' }}>{task.text || <em>Empty task</em>}</div>\r\n                                                                                {task.tags && task.tags.length > 0 && (\r\n                                                                                    <div style={{ display: 'flex', flexWrap: 'wrap', gap: '4px', marginTop: '4px' }}>\r\n                                                                                        {task.tags.map(tag => (\r\n                                                                                            <span key={tag} style={{\r\n                                                                                                background: 'var(--bg-secondary)',\r\n                                                                                                color: 'var(--accent-color)',\r\n                                                                                                border: '1px solid var(--border-color)',\r\n                                                                                                padding: '1px 8px',\r\n                                                                                                borderRadius: '12px',\r\n                                                                                                fontSize: '11px',\r\n                                                                                                fontWeight: '600',\r\n                                                                                                textDecoration: 'none'\r\n                                                                                            }}>\r\n                                                                                                #{tag}\r\n                                                                                            </span>\r\n                                                                                        ))}\r\n                                                                                    </div>\r\n                                                                                )}\r\n                                                                            </div>\r\n                                                                        </div>\r\n                                                                        <div style={{ display: 'flex', flexWrap: 'wrap', gap: '8px', alignItems: 'center', marginTop: '6px' }}>\r\n                                                                            <div style={{ display: 'flex', alignItems: 'center', gap: '4px', fontSize: '12px', fontWeight: '500', color: 'var(--text-tertiary)', background: 'var(--bg-secondary)', padding: '2px 8px', borderRadius: '4px', cursor: 'pointer' }}>\r\n                                                                                <Folder size={12} />\r\n                                                                                {task.path.slice(-1)[0]}\r\n                                                                            </div>\r\n                                                                            {task.date && (\r\n                                                                                <div>\r\n                                                                                    <InlineDateInput\r\n                                                                                        initialDate={task.date instanceof Date ? task.date.toISOString() : task.date}\r\n                                                                                        initialHasTime={task.hasTime === true || task.hasTime === 'true'}\r\n                                                                                        isChecked={task.checked}\r\n                                                                                        onDateChange={(newDateStr, newHasTime) => handleDateUpdate(task, newDateStr, newHasTime)}\r\n                                                                                        onClearDate={() => handleDateUpdate(task, null, false)}\r\n                                                                                    />\r\n                                                                                </div>\r\n                                                                            )}\r\n                                                                        </div>\r\n                                                                    </div>\r\n                                                                )}\r\n                                                            </Draggable>\r\n                                                        ))}\r\n                                                        {provided.placeholder}\r\n                                                    </div>\r\n                                                )}\r\n                                            </Droppable>\r\n                                        </div>\r\n                                    );\r\n                                })}\r\n                            </div>\r\n                        </DragDropContext>\r\n                    )}\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jonat\\Downloads\\redly\\src\\components\\HelpModal.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jonat\\Downloads\\redly\\src\\components\\InlineDateInput.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'e' is defined but never used.","line":29,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":29,"endColumn":19},{"ruleId":"no-empty","severity":2,"message":"Empty block statement.","line":29,"column":21,"nodeType":"BlockStatement","messageId":"unexpected","endLine":29,"endColumn":24,"suggestions":[{"messageId":"suggestComment","data":{"type":"block"},"fix":{"range":[1234,1235],"text":" /* empty */ "},"desc":"Add comment inside empty block statement."}]},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n  34 |     useEffect(() => {\n  35 |         if (!isEditing) {\n> 36 |             setEditValue(display);\n     |             ^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  37 |         }\n  38 |     }, [display, isEditing]);\n  39 |","line":36,"column":13,"nodeType":null,"endLine":36,"endColumn":25}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport { getDateColor, parseDateString } from '../utils/dateHelpers';\r\n\r\nexport default function InlineDateInput({\r\n    initialDate,\r\n    initialHasTime,\r\n    isChecked,\r\n    onDateChange,\r\n    onClearDate\r\n}) {\r\n    const isTimeSet = initialHasTime === true || initialHasTime === 'true';\r\n    const [isEditing, setIsEditing] = useState(false);\r\n    const [editValue, setEditValue] = useState('');\r\n\r\n    let display = isTimeSet ? \"Set Date & Time\" : \"Set Date\";\r\n    let dateColor = 'var(--accent-color)';\r\n\r\n    if (initialDate) {\r\n        try {\r\n            // Handle both T-separator (\"2026-02-25T22:00\") and space-separator (\"2026-02-25 22:00\")\r\n            const sep = initialDate.includes('T') ? 'T' : ' ';\r\n            const sepIdx = initialDate.indexOf(sep);\r\n            const datePart = sepIdx !== -1 ? initialDate.substring(0, sepIdx) : initialDate;\r\n            const timePart = (sepIdx !== -1 && isTimeSet) ? initialDate.substring(sepIdx + 1, sepIdx + 6) : '';\r\n            const [y, m, d] = datePart.split('-');\r\n            if (y && m && d) {\r\n                display = `${d}/${m}/${y}${timePart ? ' ' + timePart : ''}`.trim();\r\n            }\r\n        } catch (e) { }\r\n        dateColor = getDateColor(initialDate, isTimeSet);\r\n    }\r\n\r\n    // Sync external changes\r\n    useEffect(() => {\r\n        if (!isEditing) {\r\n            setEditValue(display);\r\n        }\r\n    }, [display, isEditing]);\r\n\r\n    const commitDateChange = (val) => {\r\n        if (!val || val.trim() === '') {\r\n            onClearDate(new Event('clear'));\r\n            setIsEditing(false);\r\n            return;\r\n        }\r\n\r\n        const { parsedDate, hasDate, hasTime } = parseDateString(val);\r\n        if (hasDate) {\r\n            onDateChange(parsedDate, hasTime);\r\n        }\r\n        setIsEditing(false);\r\n    };\r\n\r\n    const handleKeyDown = (e) => {\r\n        if (e.key === 'Tab') {\r\n            e.preventDefault();\r\n            const today = new Date();\r\n            const d = String(today.getDate()).padStart(2, '0');\r\n            const m = String(today.getMonth() + 1).padStart(2, '0');\r\n            const y = today.getFullYear();\r\n            setEditValue(`${d}/${m}/${y}`);\r\n        } else if (e.key === 'Enter') {\r\n            e.preventDefault();\r\n            commitDateChange(editValue);\r\n        } else if (e.key === 'Escape') {\r\n            e.preventDefault();\r\n            setIsEditing(false);\r\n            setEditValue(display);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div style={{ position: 'relative', display: 'flex', alignItems: 'center' }}>\r\n            {isEditing ? (\r\n                <input\r\n                    type=\"text\"\r\n                    value={editValue}\r\n                    onChange={(e) => setEditValue(e.target.value)}\r\n                    onKeyDown={handleKeyDown}\r\n                    onBlur={() => commitDateChange(editValue)}\r\n                    autoFocus\r\n                    onClick={(e) => e.stopPropagation()}\r\n                    aria-label=\"Edit due date. Type a date like 'friday' or 'tomorrow 5pm'. Press Tab for today.\"\r\n                    style={{\r\n                        background: 'transparent', border: '1px dashed var(--accent-color)',\r\n                        color: 'var(--accent-color)', fontWeight: '600', fontSize: '11px',\r\n                        fontFamily: 'monospace', padding: '2px 4px', borderRadius: '4px',\r\n                        outline: 'none', width: `${Math.max(editValue.length + 2, 12)}ch`\r\n                    }}\r\n                />\r\n            ) : (\r\n                <button\r\n                    onClick={(e) => {\r\n                        e.stopPropagation();\r\n                        // Pre-fill \"HH:MM\" so it's obvious to the user they can add a time\r\n                        setEditValue(isTimeSet ? display : `${display} HH:MM`);\r\n                        setIsEditing(true);\r\n                    }}\r\n                    aria-label={`Due date: ${display}. Click to edit.`}\r\n                    style={{\r\n                        background: isChecked ? 'var(--bg-secondary)' : dateColor,\r\n                        color: isChecked ? 'var(--text-tertiary)' : 'var(--color-badge-text)',\r\n                        padding: '2px 6px', borderRadius: '4px', border: 'none',\r\n                        fontWeight: '600', fontSize: '0.85em', display: 'inline-flex', alignItems: 'center', gap: '4px', cursor: 'pointer'\r\n                    }}\r\n                    title=\"Click to edit date/time text\"\r\n                >\r\n                    <span aria-hidden=\"true\">{isTimeSet ? 'ÔÅ▒' : '­ƒôà'}</span> Due: {display}\r\n                </button>\r\n            )}\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jonat\\Downloads\\redly\\src\\components\\RedlyLogo.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jonat\\Downloads\\redly\\src\\components\\Sidebar.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'isInitializing' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":10,"column":19,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":33,"suggestions":[{"messageId":"removeVar","data":{"varName":"isInitializing"},"fix":{"range":[516,532],"text":""},"desc":"Remove unused variable 'isInitializing'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'disconnectWorkspace' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":12,"column":23,"nodeType":"Identifier","messageId":"unusedVar","endLine":12,"endColumn":42,"suggestions":[{"messageId":"removeVar","data":{"varName":"disconnectWorkspace"},"fix":{"range":[669,690],"text":""},"desc":"Remove unused variable 'disconnectWorkspace'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'isDarkMode' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":12,"column":44,"nodeType":"Identifier","messageId":"unusedVar","endLine":12,"endColumn":54,"suggestions":[{"messageId":"removeVar","data":{"varName":"isDarkMode"},"fix":{"range":[690,702],"text":""},"desc":"Remove unused variable 'isDarkMode'."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect, useCallback } from 'react';\r\nimport { useNotes } from '../context/NotesContext';\r\nimport { Plus, FolderPlus, X, FileText, HelpCircle, CheckSquare, ChevronsDown, ChevronsUp } from 'lucide-react';\r\nimport FileTree from './FileTree';\r\nimport RedlyLogo from './RedlyLogo';\r\n\r\nexport default function Sidebar({ isOpen, onClose, onOpenHelp, setShowTasks, onGoHome }) {\r\n    const {\r\n        tree, nodes, activeFileId, setActiveFileId, addNode, expandAll, collapseAll,\r\n        editNode, isInitializing, globalAddingState, setGlobalAddingState,\r\n        lastInteractedNodeId, setLastInteractedNodeId, expandedFolders,\r\n        toggleFolder, disconnectWorkspace, isDarkMode\r\n    } = useNotes();\r\n\r\n    const [newName, setNewName] = useState('');\r\n\r\n    const isAdding = globalAddingState.type;\r\n    const targetFolder = globalAddingState.parentId;\r\n\r\n    const handleAdd = async (e) => {\r\n        e.preventDefault();\r\n        if (!newName.trim()) return;\r\n        await addNode(newName.trim(), isAdding, targetFolder); // Adding to target\r\n        setNewName('');\r\n        setGlobalAddingState({ type: null, parentId: null });\r\n    };\r\n\r\n    const handleNewItem = useCallback((type) => {\r\n        const targetNode = nodes.find(n => n.id === lastInteractedNodeId) || nodes.find(n => n.id === activeFileId);\r\n        const parentId = targetNode ? (targetNode.type === 'folder' ? targetNode.id : targetNode.parentId) : null;\r\n        setGlobalAddingState({ type, parentId });\r\n        if (parentId && !expandedFolders.has(parentId)) toggleFolder(parentId);\r\n    }, [nodes, lastInteractedNodeId, activeFileId, setGlobalAddingState, expandedFolders, toggleFolder]);\r\n\r\n    // Flatten visible nodes for keyboard navigation\r\n    const getVisibleNodes = useCallback(() => {\r\n        const visible = [];\r\n        const traverse = (nodeList) => {\r\n            for (const node of nodeList) {\r\n                visible.push(node);\r\n                if (node.type === 'folder' && expandedFolders.has(node.id) && node.children) {\r\n                    traverse(node.children);\r\n                }\r\n            }\r\n        };\r\n        traverse(tree);\r\n        return visible;\r\n    }, [tree, expandedFolders]);\r\n\r\n    useEffect(() => {\r\n        const handleKeyDown = (e) => {\r\n            // Ignore if typing in an input/textarea\r\n            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.closest('.ProseMirror')) {\r\n                return;\r\n            }\r\n\r\n            if (e.altKey && !e.shiftKey && e.key.toLowerCase() === 'n') {\r\n                e.preventDefault();\r\n                handleNewItem('file');\r\n                return;\r\n            } else if (e.altKey && !e.shiftKey && e.key.toLowerCase() === 'f') {\r\n                e.preventDefault();\r\n                handleNewItem('folder');\r\n                return;\r\n            }\r\n\r\n            // Tree navigation\r\n            const visibleNodes = getVisibleNodes();\r\n            if (visibleNodes.length === 0) return;\r\n\r\n            const currentIndex = visibleNodes.findIndex(n => n.id === lastInteractedNodeId);\r\n            const currentNode = currentIndex !== -1 ? visibleNodes[currentIndex] : null;\r\n\r\n            if (e.key === 'ArrowDown') {\r\n                e.preventDefault();\r\n                if (currentIndex === -1) {\r\n                    setLastInteractedNodeId(visibleNodes[0].id);\r\n                } else if (currentIndex < visibleNodes.length - 1) {\r\n                    setLastInteractedNodeId(visibleNodes[currentIndex + 1].id);\r\n                }\r\n            } else if (e.key === 'ArrowUp') {\r\n                e.preventDefault();\r\n                if (currentIndex > 0) {\r\n                    setLastInteractedNodeId(visibleNodes[currentIndex - 1].id);\r\n                } else if (currentIndex === -1) {\r\n                    setLastInteractedNodeId(visibleNodes[visibleNodes.length - 1].id);\r\n                }\r\n            } else if (e.key === 'ArrowRight' && currentNode) {\r\n                e.preventDefault();\r\n                if (currentNode.type === 'folder') {\r\n                    if (!expandedFolders.has(currentNode.id)) {\r\n                        toggleFolder(currentNode.id);\r\n                    } else if (currentIndex < visibleNodes.length - 1 && visibleNodes[currentIndex + 1].parentId === currentNode.id) {\r\n                        // Move to first child\r\n                        setLastInteractedNodeId(visibleNodes[currentIndex + 1].id);\r\n                    }\r\n                } else if (currentNode.type === 'file') {\r\n                    // Open the file and focus the editor\r\n                    setActiveFileId(currentNode.id);\r\n                    setTimeout(() => {\r\n                        document.querySelector('.ProseMirror')?.focus();\r\n                    }, 50);\r\n                }\r\n            } else if (e.key === 'ArrowLeft' && currentNode) {\r\n                e.preventDefault();\r\n                if (currentNode.type === 'folder' && expandedFolders.has(currentNode.id)) {\r\n                    toggleFolder(currentNode.id);\r\n                } else if (currentNode.parentId) {\r\n                    setLastInteractedNodeId(currentNode.parentId);\r\n                }\r\n            } else if ((e.key === 'Enter' || e.key === ' ') && currentNode) {\r\n                e.preventDefault();\r\n                if (currentNode.type === 'folder') {\r\n                    toggleFolder(currentNode.id);\r\n                } else {\r\n                    setActiveFileId(currentNode.id);\r\n                }\r\n            }\r\n        };\r\n\r\n        window.addEventListener('keydown', handleKeyDown);\r\n        return () => window.removeEventListener('keydown', handleKeyDown);\r\n    }, [handleNewItem, getVisibleNodes, lastInteractedNodeId, expandedFolders, toggleFolder, setActiveFileId, setLastInteractedNodeId]);\r\n\r\n    return (\r\n        <aside className={`sidebar ${isOpen ? 'open' : ''}`} role=\"navigation\" aria-label=\"Main Navigation\">\r\n            <div className=\"sidebar-header\" style={{ padding: '16px', flexDirection: 'column', alignItems: 'stretch', gap: '12px' }}>\r\n                <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>\r\n                    <div style={{ display: 'flex', flexDirection: 'row', alignItems: 'center', flexWrap: 'wrap', gap: '8px' }}>\r\n                        <div\r\n                            style={{ display: 'flex', alignItems: 'center', gap: '8px', cursor: 'pointer' }}\r\n                            onClick={onGoHome}\r\n                            title=\"Go to Home\"\r\n                            role=\"button\"\r\n                            aria-label=\"Redly Home\"\r\n                        >\r\n                            <RedlyLogo size={28} showText={false} />\r\n                        </div>\r\n                    </div>\r\n                    <div style={{ display: 'flex', gap: '4px' }}>\r\n                        {expandedFolders.size > 0 ? (\r\n                            <button className=\"icon-button\" onClick={collapseAll} title=\"Collapse All Folders\" aria-label=\"Collapse All Folders\" style={{ marginRight: '8px' }}>\r\n                                <ChevronsUp size={14} aria-hidden=\"true\" />\r\n                            </button>\r\n                        ) : (\r\n                            <button className=\"icon-button\" onClick={expandAll} title=\"Expand All Folders\" aria-label=\"Expand All Folders\" style={{ marginRight: '8px' }}>\r\n                                <ChevronsDown size={14} aria-hidden=\"true\" />\r\n                            </button>\r\n                        )}\r\n                        <div style={{ width: '1px', background: 'var(--border-color)', margin: '4px 0', marginRight: '4px' }}></div>\r\n                        <button className=\"icon-button\" onClick={() => handleNewItem('file')} title=\"New Note (Alt+N)\" aria-label=\"Create New Note\">\r\n                            <Plus size={16} aria-hidden=\"true\" />\r\n                        </button>\r\n                        <button className=\"icon-button\" onClick={() => handleNewItem('folder')} title=\"New Folder (Alt+F)\" aria-label=\"Create New Folder\">\r\n                            <FolderPlus size={16} aria-hidden=\"true\" />\r\n                        </button>\r\n                        {isOpen && (\r\n                            <button className=\"icon-button\" onClick={onClose} style={{ display: 'none' }} aria-label=\"Close Sidebar\">\r\n                                <X size={18} aria-hidden=\"true\" />\r\n                            </button>\r\n                        )}\r\n                    </div>\r\n                </div>\r\n\r\n                <button\r\n                    onClick={setShowTasks}\r\n                    aria-label=\"View Global Tasks\"\r\n                    style={{\r\n                        display: 'flex', alignItems: 'center', gap: '8px', padding: '8px',\r\n                        background: 'var(--bg-secondary)', border: 'none', borderRadius: '6px',\r\n                        color: 'var(--text-primary)', fontSize: '14px', cursor: 'pointer',\r\n                        fontWeight: 500, transition: 'background 0.2s', width: '100%'\r\n                    }}\r\n                    onMouseEnter={(e) => e.target.style.background = 'var(--bg-hover)'}\r\n                    onMouseLeave={(e) => e.target.style.background = 'var(--bg-secondary)'}\r\n                >\r\n                    <CheckSquare size={16} style={{ color: 'var(--accent-color)' }} aria-hidden=\"true\" />\r\n                    Global Tasks\r\n                </button>\r\n            </div>\r\n\r\n\r\n            <div\r\n                className=\"sidebar-content\"\r\n                role=\"tree\"\r\n                aria-label=\"Notes Explorer\"\r\n                onClick={() => setLastInteractedNodeId(null)}\r\n                onDragOver={e => {\r\n                    e.preventDefault();\r\n                    e.dataTransfer.dropEffect = 'move';\r\n                }}\r\n                onDrop={e => {\r\n                    e.preventDefault();\r\n                    // Drop to Root if they drop anywhere in the sidebar content\r\n                    const draggedId = e.dataTransfer.getData('text/plain');\r\n                    if (draggedId) {\r\n                        editNode(draggedId, { parentId: null });\r\n                    }\r\n                }}\r\n\r\n            >\r\n                {isAdding && targetFolder === null && (\r\n                    <form onSubmit={handleAdd} style={{ padding: '8px', display: 'flex', gap: '8px', background: 'transparent', borderBottom: '1px solid var(--border-color)' }}>\r\n                        {isAdding === 'folder' ? <FolderPlus size={16} /> : <FileText size={16} />}\r\n                        <input\r\n                            autoFocus\r\n                            className=\"title-input\"\r\n                            style={{ fontSize: '14px', borderBottom: '1px solid var(--border-color)', borderRadius: 0, width: '100%' }}\r\n                            value={newName}\r\n                            onChange={(e) => setNewName(e.target.value)}\r\n                            placeholder={`New ${isAdding}...`}\r\n                            onBlur={() => setGlobalAddingState({ type: null, parentId: null })}\r\n                        />\r\n                    </form>\r\n                )}\r\n\r\n                {tree.length === 0 && !isAdding ? (\r\n                    <div style={{ padding: '16px', color: 'var(--text-tertiary)', fontSize: '14px', textAlign: 'center' }}>\r\n                        No notes yet. Create one!\r\n                    </div>\r\n                ) : (\r\n                    tree.map(node => <FileTree key={node.id} node={node} depth={0} />)\r\n                )}\r\n            </div>\r\n\r\n            <div className=\"sidebar-footer\" style={{\r\n                padding: '12px',\r\n                borderTop: '1px solid var(--border-color)',\r\n                display: 'flex',\r\n                gap: '8px',\r\n                justifyContent: 'center',\r\n                flexShrink: 0\r\n            }}>\r\n                <button\r\n                    onClick={onOpenHelp}\r\n                    aria-label=\"Open Keyboard Shortcuts and Help\"\r\n                    style={{\r\n                        flex: 1, display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px',\r\n                        background: 'var(--bg-accent)', border: 'none', padding: '8px', borderRadius: '6px',\r\n                        color: 'var(--text-secondary)', cursor: 'pointer', fontSize: '14px'\r\n                    }}\r\n                    title=\"Shortcuts & Help\"\r\n                >\r\n                    <HelpCircle size={16} aria-hidden=\"true\" /> Redly Guide\r\n                </button>\r\n            </div>\r\n        </aside>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jonat\\Downloads\\redly\\src\\components\\WelcomeScreen.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'isDarkMode' is defined but never used.","line":6,"column":47,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":57,"suggestions":[{"messageId":"removeVar","data":{"varName":"isDarkMode"},"fix":{"range":[318,330],"text":""},"desc":"Remove unused variable 'isDarkMode'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'isDarkMode' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":156,"column":146,"nodeType":"Identifier","messageId":"unusedVar","endLine":156,"endColumn":156,"suggestions":[{"messageId":"removeVar","data":{"varName":"isDarkMode"},"fix":{"range":[9280,9292],"text":""},"desc":"Remove unused variable 'isDarkMode'."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react';\r\nimport { useNotes } from '../context/NotesContext';\r\nimport { FileText, FolderPlus, ListTodo, Clock, HardDrive, ShieldCheck, Box, Unlock, Monitor, Share, PlusSquare, MoreVertical, X } from 'lucide-react';\r\nimport RedlyLogo from './RedlyLogo';\r\n\r\nconst InstallGuideModal = ({ isOpen, onClose, isDarkMode }) => {\r\n    if (!isOpen) return null;\r\n\r\n    const browser = (() => {\r\n        const ua = navigator.userAgent.toLowerCase();\r\n        if (ua.includes('chrome')) return 'chrome';\r\n        if (ua.includes('safari') && !ua.includes('chrome')) return 'safari';\r\n        if (ua.includes('edge')) return 'edge';\r\n        return 'chrome';\r\n    })();\r\n\r\n    return (\r\n        <div className=\"modal-overlay\" onClick={onClose}>\r\n            <div className=\"modal-content\" onClick={e => e.stopPropagation()} style={{ maxWidth: '440px' }}>\r\n                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '24px' }}>\r\n                    <h2 style={{ fontSize: '20px', fontWeight: '800', margin: 0 }}>Install Redly</h2>\r\n                    <button onClick={onClose} className=\"icon-button\" style={{ padding: '8px' }}>\r\n                        <X size={20} />\r\n                    </button>\r\n                </div>\r\n\r\n                <div style={{ textAlign: 'center', marginBottom: '24px' }}>\r\n                    <div style={{\r\n                        width: '80px',\r\n                        height: '80px',\r\n                        background: 'var(--bg-secondary)',\r\n                        borderRadius: '20px',\r\n                        display: 'flex',\r\n                        alignItems: 'center',\r\n                        justifyContent: 'center',\r\n                        margin: '0 auto 16px',\r\n                        border: '1px solid var(--border-color)'\r\n                    }}>\r\n                        <Monitor size={40} style={{ color: 'var(--accent-color)' }} />\r\n                    </div>\r\n                    <p style={{ fontSize: '15px', color: 'var(--text-secondary)', lineHeight: '1.5' }}>\r\n                        Install Redly as a standalone app for an offline-first, distraction-free experience.\r\n                    </p>\r\n                </div>\r\n\r\n                <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>\r\n                    {browser === 'safari' ? (\r\n                        <>\r\n                            <div style={{ display: 'flex', gap: '12px', alignItems: 'flex-start' }}>\r\n                                <div style={{ background: 'var(--bg-secondary)', padding: '8px', borderRadius: '8px', fontWeight: 'bold', fontSize: '14px', minWidth: '32px', textAlign: 'center' }}>1</div>\r\n                                <p style={{ margin: 0, fontSize: '14px' }}>Tap the <strong>Share</strong> button <Share size={16} style={{ verticalAlign: 'middle' }} /> in the toolbar.</p>\r\n                            </div>\r\n                            <div style={{ display: 'flex', gap: '12px', alignItems: 'flex-start' }}>\r\n                                <div style={{ background: 'var(--bg-secondary)', padding: '8px', borderRadius: '8px', fontWeight: 'bold', fontSize: '14px', minWidth: '32px', textAlign: 'center' }}>2</div>\r\n                                <p style={{ margin: 0, fontSize: '14px' }}>Scroll down and select <strong>'Add to Home Screen'</strong> <PlusSquare size={16} style={{ verticalAlign: 'middle' }} />.</p>\r\n                            </div>\r\n                        </>\r\n                    ) : (\r\n                        <>\r\n                            <div style={{ display: 'flex', gap: '12px', alignItems: 'flex-start' }}>\r\n                                <div style={{ background: 'var(--bg-secondary)', padding: '8px', borderRadius: '8px', fontWeight: 'bold', fontSize: '14px', minWidth: '32px', textAlign: 'center' }}>1</div>\r\n                                <p style={{ margin: 0, fontSize: '14px' }}>Click the <strong>Menu</strong> icon <MoreVertical size={16} style={{ verticalAlign: 'middle' }} /> in the top-right corner.</p>\r\n                            </div>\r\n                            <div style={{ display: 'flex', gap: '12px', alignItems: 'flex-start' }}>\r\n                                <div style={{ background: 'var(--bg-secondary)', padding: '8px', borderRadius: '8px', fontWeight: 'bold', fontSize: '14px', minWidth: '32px', textAlign: 'center' }}>2</div>\r\n                                <p style={{ margin: 0, fontSize: '14px' }}>Select <strong>'Cast, save and share'</strong> &gt; <strong>'Install page as app...'</strong>.</p>\r\n                            </div>\r\n                        </>\r\n                    )}\r\n                </div>\r\n\r\n                <button onClick={onClose} className=\"primary-action-btn\" style={{ width: '100%', marginTop: '32px', padding: '12px', fontSize: '16px', justifyContent: 'center' }}>\r\n                    Got it\r\n                </button>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nconst renderLogo = (size = 80) => (\r\n    <div style={{ marginBottom: '24px', display: 'flex', justifyContent: 'center' }}>\r\n        <RedlyLogo size={size} showText={true} style={{ maxWidth: '320px' }} />\r\n    </div>\r\n);\r\n\r\nconst SHARED_STYLES = `\r\n    .welcome-container { \r\n        display: flex; \r\n        flex-direction: column; \r\n        align-items: center; \r\n        justify-content: center; \r\n        height: 100%; \r\n        width: 100%;\r\n        padding: 40px 20px; \r\n        text-align: center; \r\n        color: var(--text-primary); \r\n        background-color: var(--bg-primary); \r\n        overflow-y: auto; \r\n    }\r\n    \r\n    .primary-action-btn { background: var(--accent-color); color: white; border: none; padding: 16px 32px; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 14px 0 rgba(0, 112, 243, 0.39); transition: transform 0.2s, box-shadow 0.2s; display: flex; align-items: center; gap: 12px; }\r\n    .primary-action-btn:hover { transform: translateY(-2px); }\r\n    .primary-action-btn:active { transform: scale(0.98); }\r\n    .primary-action-btn:disabled { opacity: 0.5; cursor: not-allowed; }\r\n    \r\n    .secondary-action-btn { background: transparent; border: 1px solid var(--border-color); padding: 12px 24px; border-radius: 12px; font-weight: 600; cursor: pointer; color: var(--text-secondary); transition: all 0.2s; }\r\n    .secondary-action-btn:hover { background: var(--bg-secondary); border-color: var(--text-tertiary); }\r\n\r\n    .welcome-card { display: flex; flex-direction: column; align-items: center; justify-content: center; background: var(--bg-secondary); border: 1px solid var(--border-color); padding: 16px; border-radius: 12px; cursor: pointer; transition: all 0.2s ease; gap: 8px; width: 100%; border-bottom-width: 4px; color: var(--text-primary); }\r\n    .welcome-card:hover { border-color: var(--accent-color); transform: translateY(-2px); }\r\n    .welcome-card:active { transform: translateY(0); border-bottom-width: 1px; margin-top: 3px; }\r\n\r\n    .storage-option-btn { background: var(--bg-secondary); border: 1px solid var(--border-color); padding: 16px; border-radius: 16px; cursor: pointer; text-align: left; max-width: 240px; transition: all 0.2s ease; display: flex; flex-direction: column; align-items: flex-start; height: 100%; border-bottom-width: 4px; color: var(--text-primary); }\r\n    .storage-option-btn:hover { border-color: var(--accent-color); transform: translateY(-4px); }\r\n    .storage-option-btn:active { transform: translateY(0); border-bottom-width: 1px; margin-top: 3px; }\r\n\r\n    .modal-overlay { \r\n        position: fixed; \r\n        top: 0; \r\n        left: 0; \r\n        width: 100%; \r\n        height: 100%; \r\n        background: rgba(0,0,0,0.85); \r\n        backdrop-filter: blur(12px); \r\n        display: flex; \r\n        align-items: center; \r\n        justify-content: center; \r\n        z-index: 100000; \r\n        padding: 20px;\r\n    }\r\n    \r\n    .modal-content { \r\n        background: var(--bg-primary); \r\n        padding: 40px; \r\n        border-radius: 32px; \r\n        border: 1px solid var(--border-color); \r\n        box-shadow: 0 30px 60px rgba(0,0,0,0.5); \r\n        max-width: 500px; \r\n        width: 100%; \r\n        text-align: left; \r\n        animation: modal-in 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);\r\n    }\r\n\r\n    @keyframes modal-in {\r\n        from { opacity: 0; transform: scale(0.9) translateY(20px); }\r\n        to { opacity: 1; transform: scale(1) translateY(0); }\r\n    }\r\n\r\n    .recent-file-chip { display: flex; align-items: flex-start; gap: 12px; background: var(--bg-secondary); border: 1px solid var(--border-color); padding: 12px 16px; border-radius: 8px; cursor: pointer; transition: all 0.2s ease; text-align: left; width: 100%; }\r\n    .recent-file-chip:hover { border-color: var(--accent-color); background: var(--bg-hover); }\r\n\r\n    .badge-cloud { background: rgba(37, 99, 235, 0.1); color: var(--accent-color); padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: 700; text-transform: uppercase; margin-bottom: 8px; }\r\n`;\r\n\r\nexport default function WelcomeScreen({ openHelp }) {\r\n    const { addNode, nodes, setActiveFileId, workspaceHandle, selectWorkspace, needsPermission, grantLocalPermission, installApp, isInstallable, isDarkMode, showInstallModal, setShowInstallModal } = useNotes();\r\n    const recentFiles = nodes\r\n        .filter(n => n.type === 'file')\r\n        .sort((a, b) => (b.updatedAt || 0) - (a.updatedAt || 0))\r\n        .slice(0, 4);\r\n\r\n\r\n    if (needsPermission) {\r\n        return (\r\n            <div className=\"welcome-container\">\r\n                <style>{SHARED_STYLES}</style>\r\n                {renderLogo()}\r\n                <h1 style={{ fontSize: '32px', marginBottom: '16px', fontWeight: '800', letterSpacing: '-0.5px' }}>Reconnect Workspace</h1>\r\n                <p style={{ fontSize: '18px', color: 'var(--text-secondary)', marginBottom: '40px', maxWidth: '500px' }}>\r\n                    Browser security requires you re-verify access to your local <code>Redly</code> folder for this session.\r\n                </p>\r\n                <button onClick={grantLocalPermission} className=\"primary-action-btn\" aria-label=\"Unlock Folder and grant storage permissions\">\r\n                    <Unlock size={24} aria-hidden=\"true\" />\r\n                    Unlock Folder\r\n                </button>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    if (!workspaceHandle) {\r\n        return (\r\n            <div className=\"welcome-container\">\r\n                <style>{SHARED_STYLES}</style>\r\n                {renderLogo()}\r\n\r\n                {isInstallable && (\r\n                    <button\r\n                        onClick={installApp}\r\n                        className=\"primary-action-btn\"\r\n                        style={{\r\n                            marginBottom: '40px',\r\n                            fontSize: '15px',\r\n                            padding: '14px 28px',\r\n                            justifyContent: 'center',\r\n                            width: '100%',\r\n                            maxWidth: '320px',\r\n                            background: 'var(--bg-secondary)',\r\n                            color: 'var(--accent-color)',\r\n                            border: '1px solid var(--border-color)',\r\n                            boxShadow: '0 4px 12px rgba(0,0,0,0.1)'\r\n                        }}\r\n                        aria-label=\"Install Redly as a Desktop App\"\r\n                    >\r\n                        <ShieldCheck size={20} />\r\n                        <span>Install Redly Desktop App</span>\r\n                    </button>\r\n                )}\r\n\r\n                <p style={{ fontSize: '18px', color: 'var(--text-secondary)', marginBottom: '48px', maxWidth: '550px', lineHeight: '1.5' }}>\r\n                    Your private, offline-first Markdown knowledge base.\r\n                </p>\r\n                <div style={{ display: 'flex', gap: '20px', flexWrap: 'wrap', justifyContent: 'center', maxWidth: '1000px', width: '100%' }}>\r\n                    <button onClick={() => selectWorkspace('sandbox')} className=\"storage-option-btn\" aria-label=\"Select Browser Storage: Hidden browser sandbox\">\r\n                        <Box size={24} style={{ color: 'var(--color-future)', marginBottom: '12px' }} aria-hidden=\"true\" />\r\n                        <h3 style={{ fontWeight: '700', fontSize: '16px', marginBottom: '4px' }}>Browser Storage</h3>\r\n                        <p style={{ fontSize: '12px', color: 'var(--text-tertiary)', margin: 0, lineHeight: '1.4' }}>Store notes in a hidden, secure browser sandbox. Fast and zero-config.</p>\r\n                    </button>\r\n\r\n                    <button onClick={() => selectWorkspace('local')} className=\"storage-option-btn\" aria-label=\"Select Local Storage: Visible markdown files on your computer\">\r\n                        <HardDrive size={24} style={{ color: 'var(--accent-color)', marginBottom: '12px' }} aria-hidden=\"true\" />\r\n                        <h3 style={{ fontWeight: '700', fontSize: '16px', marginBottom: '4px' }}>Local Storage</h3>\r\n                        <p style={{ fontSize: '12px', color: 'var(--text-tertiary)', margin: 0, lineHeight: '1.4' }}>Save notes as visible <code>.md</code> files on your computer. Your data, your control.</p>\r\n                    </button>\r\n                </div>\r\n                <InstallGuideModal isOpen={showInstallModal} onClose={() => setShowInstallModal(false)} />\r\n            </div>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <div className=\"welcome-container\">\r\n            <style>{SHARED_STYLES}</style>\r\n            {renderLogo(60)}\r\n\r\n            <h1 style={{ fontSize: '32px', marginBottom: '8px', fontWeight: '800', letterSpacing: '-0.5px', textAlign: 'center' }}>What's next?</h1>\r\n\r\n            {isInstallable && (\r\n                <button\r\n                    onClick={installApp}\r\n                    className=\"primary-action-btn\"\r\n                    style={{\r\n                        marginBottom: '32px',\r\n                        fontSize: '14px',\r\n                        padding: '10px 20px',\r\n                        justifyContent: 'center',\r\n                        background: 'var(--bg-secondary)',\r\n                        color: 'var(--accent-color)',\r\n                        border: '1px solid var(--border-color)',\r\n                        boxShadow: 'none',\r\n                        height: 'auto'\r\n                    }}\r\n                >\r\n                    <ShieldCheck size={18} />\r\n                    <span>Install Redly App</span>\r\n                </button>\r\n            )}\r\n\r\n            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '16px', width: '100%', maxWidth: '600px', marginBottom: '48px' }}>\r\n                <button onClick={() => addNode('Untitled Note', 'file')} className=\"welcome-card\" aria-label=\"Create a New Note\">\r\n                    <FileText size={24} style={{ color: 'var(--accent-color)' }} aria-hidden=\"true\" />\r\n                    <span style={{ fontWeight: '600' }}>New Note</span>\r\n                </button>\r\n                <button onClick={() => addNode('New Folder', 'folder')} className=\"welcome-card\" aria-label=\"Create a New Folder\">\r\n                    <FolderPlus size={24} style={{ color: 'var(--color-future)' }} aria-hidden=\"true\" />\r\n                    <span style={{ fontWeight: '600' }}>New Folder</span>\r\n                </button>\r\n                <button onClick={openHelp} className=\"welcome-card\" aria-label=\"Open Help and Shortcuts\">\r\n                    <ListTodo size={24} style={{ color: 'var(--color-today)' }} aria-hidden=\"true\" />\r\n                    <span style={{ fontWeight: '600' }}>Redly Guide</span>\r\n\r\n                </button>\r\n            </div>\r\n\r\n            {recentFiles.length > 0 && (\r\n                <div style={{ width: '100%', maxWidth: '600px', textAlign: 'left' }}>\r\n                    <div style={{ display: 'flex', alignItems: 'center', gap: '8px', color: 'var(--text-tertiary)', fontSize: '13px', fontWeight: '700', textTransform: 'uppercase', marginBottom: '16px', letterSpacing: '1px' }}>\r\n                        <Clock size={14} /> Recent Notes\r\n                    </div>\r\n                    <div style={{ display: 'grid', gap: '12px' }}>\r\n                        {recentFiles.map(file => (\r\n                            <button key={file.id} onClick={() => setActiveFileId(file.id)} className=\"recent-file-chip\">\r\n                                <FileText size={16} style={{ color: 'var(--accent-color)', marginTop: '2px' }} />\r\n                                <div style={{ overflow: 'hidden' }}>\r\n                                    <div style={{ fontWeight: '600', color: 'var(--text-primary)', whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis' }}>{file.name}</div>\r\n                                    <div style={{ fontSize: '11px', color: 'var(--text-tertiary)' }}>{new Date(file.updatedAt).toLocaleDateString()}</div>\r\n                                </div>\r\n                            </button>\r\n                        ))}\r\n                    </div>\r\n                </div>\r\n            )}\r\n\r\n            <InstallGuideModal isOpen={showInstallModal} onClose={() => setShowInstallModal(false)} />\r\n        </div>\r\n    );\r\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jonat\\Downloads\\redly\\src\\context\\NotesContext.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'notifiedTaskIds' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":53,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":53,"endColumn":27,"suggestions":[{"messageId":"removeVar","data":{"varName":"notifiedTaskIds"},"fix":{"range":[2588,2603],"text":""},"desc":"Remove unused variable 'notifiedTaskIds'."}]},{"ruleId":"react-refresh/only-export-components","severity":2,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":434,"column":14,"nodeType":"Identifier","messageId":"namedExport","endLine":434,"endColumn":22}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { createContext, useContext, useEffect, useState, useCallback, useRef } from 'react';\r\nimport { loadSavedWorkspace, initWorkspace, requestLocalPermission, clearWorkspaceHandle, getNodes, createNode, updateNode, deleteNode, buildTree, getHandle, getFileContent } from '../lib/db';\r\nimport { parseTasksFromNodes } from '../utils/taskParser';\r\nimport { checkUpcomingTasks } from '../utils/notificationManager';\r\n\r\nconst NotesContext = createContext(undefined);\r\n\r\nexport const NotesProvider = ({ children }) => {\r\n    const [nodes, setNodes] = useState([]);\r\n    const [workspaceHandle, setWorkspaceHandle] = useState(null); // 'active' flag\r\n    const [storageMode, setStorageMode] = useState(null);\r\n    const [isInitializing, setIsInitializing] = useState(true);\r\n    const [needsPermission, setNeedsPermission] = useState(false);\r\n\r\n    const [activeFileId, setActiveFileId] = useState(() => localStorage.getItem('redly_activeFileId') || null);\r\n    const [expandedFolders, setExpandedFolders] = useState(() => {\r\n        const saved = localStorage.getItem('redly_expandedFolders');\r\n        return saved ? new Set(JSON.parse(saved)) : new Set();\r\n    });\r\n\r\n    const [globalAddingState, setGlobalAddingState] = useState({ type: null, parentId: null });\r\n    const [lastInteractedNodeId, setLastInteractedNodeId] = useState(null);\r\n    const [deferredPrompt, setDeferredPrompt] = useState(null);\r\n    const [showInstallModal, setShowInstallModal] = useState(false);\r\n    const [isPwaInstalled, setIsPwaInstalled] = useState(() => {\r\n        return localStorage.getItem('redly_pwa_installed') === 'true';\r\n    });\r\n\r\n    const [isDarkMode, setIsDarkMode] = useState(() => {\r\n        const saved = localStorage.getItem('theme');\r\n        if (saved) return saved === 'dark';\r\n        return true; // Default to dark mode\r\n    });\r\n\r\n    useEffect(() => {\r\n        if (isDarkMode) {\r\n            document.documentElement.classList.add('dark');\r\n            localStorage.setItem('theme', 'dark');\r\n        } else {\r\n            document.documentElement.classList.remove('dark');\r\n            localStorage.setItem('theme', 'light');\r\n        }\r\n    }, [isDarkMode]);\r\n\r\n    // Refs for performance-sensitive background tasks\r\n    const nodesRef = useRef(nodes);\r\n    useEffect(() => { nodesRef.current = nodes; }, [nodes]);\r\n\r\n    const [notificationSettings, setNotificationSettings] = useState(() => {\r\n        const saved = localStorage.getItem('redly_notificationSettings');\r\n        return saved ? JSON.parse(saved) : { enabled: false, leadTime: 10 };\r\n    });\r\n    const [notifiedTaskIds, setNotifiedTaskIds] = useState(new Set());\r\n\r\n    useEffect(() => {\r\n        // If the PWA is opened in standalone mode, auto-detect it's installed\r\n        if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone) {\r\n            setIsPwaInstalled(true);\r\n            localStorage.setItem('redly_pwa_installed', 'true');\r\n        }\r\n\r\n        const handleBeforeInstallPrompt = (e) => {\r\n            e.preventDefault();\r\n            setDeferredPrompt(e);\r\n        };\r\n\r\n        const handleAppInstalled = () => {\r\n            setIsPwaInstalled(true);\r\n            localStorage.setItem('redly_pwa_installed', 'true');\r\n            setDeferredPrompt(null);\r\n        };\r\n\r\n        const handleDeferredPromptCaptured = () => {\r\n            setDeferredPrompt(window.__DEFERRED_PROMPT__);\r\n        };\r\n\r\n        // Check if the global interceptor already caught it\r\n        if (window.__DEFERRED_PROMPT__) {\r\n            setDeferredPrompt(window.__DEFERRED_PROMPT__);\r\n        } else {\r\n            // Otherwise listen for the global custom event or the native event\r\n            window.addEventListener('deferred-prompt-captured', handleDeferredPromptCaptured);\r\n        }\r\n\r\n        window.addEventListener('beforeinstallprompt', handleBeforeInstallPrompt);\r\n        window.addEventListener('appinstalled', handleAppInstalled);\r\n\r\n        return () => {\r\n            window.removeEventListener('beforeinstallprompt', handleBeforeInstallPrompt);\r\n            window.removeEventListener('appinstalled', handleAppInstalled);\r\n            window.removeEventListener('deferred-prompt-captured', handleDeferredPromptCaptured);\r\n        };\r\n    }, []);\r\n\r\n    const installApp = async () => {\r\n        if (deferredPrompt) {\r\n            try {\r\n                deferredPrompt.prompt();\r\n                const { outcome } = await deferredPrompt.userChoice;\r\n\r\n                if (outcome === 'accepted') {\r\n                    setIsPwaInstalled(true);\r\n                    localStorage.setItem('redly_pwa_installed', 'true');\r\n                }\r\n\r\n                setDeferredPrompt(null);\r\n            } catch (err) {\r\n                console.error('[NotesContext] PWA Install Prompt Failed:', err);\r\n                setShowInstallModal(true); // Fallback to modal on error\r\n                setDeferredPrompt(null);\r\n            }\r\n        } else {\r\n            // No native prompt available, show our premium guide instead\r\n            setShowInstallModal(true);\r\n        }\r\n    };\r\n\r\n    // Initial load - check if user already has a workspace configured\r\n    useEffect(() => {\r\n        const init = async () => {\r\n            try {\r\n                const status = await loadSavedWorkspace();\r\n                if (status === true) {\r\n                    setWorkspaceHandle(true);\r\n                    let mode = await getHandle('workspace_mode');\r\n                    if (!mode) mode = localStorage.getItem('redly_last_storage_mode');\r\n\r\n                    setStorageMode(mode || 'sandbox');\r\n                    setNodes(await getNodes());\r\n                } else if (status === 'requires_permission') {\r\n                    setNeedsPermission(true);\r\n                }\r\n            } catch (e) {\r\n                console.error(\"[NotesContext] Initialisation failed:\", e);\r\n            } finally {\r\n                setIsInitializing(false);\r\n            }\r\n        };\r\n        init();\r\n    }, []);\r\n\r\n    const loadNodes = useCallback(async () => {\r\n        if (!workspaceHandle) return;\r\n        try {\r\n            const freshNodes = await getNodes();\r\n            // Simple hash comparison to avoid unnecessary state updates\r\n            setNodes(prev => {\r\n                const prevJson = JSON.stringify(prev);\r\n                const nextJson = JSON.stringify(freshNodes);\r\n                if (prevJson === nextJson) return prev;\r\n                return freshNodes;\r\n            });\r\n        }\r\n        catch (e) {\r\n            console.error('Failed to load nodes:', e);\r\n        }\r\n    }, [workspaceHandle]);\r\n\r\n\r\n    // Function to request permission on boot if returning to a local folder\r\n    const grantLocalPermission = async () => {\r\n        if (await requestLocalPermission()) {\r\n            setNeedsPermission(false);\r\n            setWorkspaceHandle(true);\r\n            setNodes(await getNodes());\r\n        }\r\n    };\r\n\r\n    // Updated to handle Tiers 1 and 2\r\n    const selectWorkspace = async (mode = 'sandbox', options = {}) => {\r\n        try {\r\n            await initWorkspace(mode, options);\r\n            localStorage.setItem('redly_last_storage_mode', mode); // Fallback for UI sync\r\n            setStorageMode(mode);\r\n            setWorkspaceHandle(true);\r\n            setNodes(await getNodes());\r\n        } catch (e) {\r\n            console.error(\"Workspace selection error\", e);\r\n            throw e; // Re-throw so callers (Sidebar, WelcomeScreen) can handle auth errors\r\n        }\r\n    };\r\n\r\n    const disconnectWorkspace = async () => {\r\n\r\n        try {\r\n            await clearWorkspaceHandle();\r\n\r\n        } catch (e) {\r\n            console.error('[NotesContext] Failed to clear handles, proceeding anyway:', e);\r\n        }\r\n\r\n        setWorkspaceHandle(null);\r\n        setStorageMode(null);\r\n        setNeedsPermission(false);\r\n        setNodes([]);\r\n        setActiveFileId(null);\r\n        setExpandedFolders(new Set());\r\n\r\n    };\r\n\r\n    useEffect(() => {\r\n        if (activeFileId) localStorage.setItem('redly_activeFileId', activeFileId);\r\n        else localStorage.removeItem('redly_activeFileId');\r\n    }, [activeFileId]);\r\n\r\n    useEffect(() => {\r\n        localStorage.setItem('redly_expandedFolders', JSON.stringify(Array.from(expandedFolders)));\r\n    }, [expandedFolders]);\r\n\r\n    useEffect(() => {\r\n        localStorage.setItem('redly_notificationSettings', JSON.stringify(notificationSettings));\r\n    }, [notificationSettings]);\r\n\r\n    // Keep a ref to latest notification settings to avoid stale closures in the interval\r\n    const notificationSettingsRef = useRef(notificationSettings);\r\n    useEffect(() => { notificationSettingsRef.current = notificationSettings; }, [notificationSettings]);\r\n\r\n    // Background task notification checker\r\n    useEffect(() => {\r\n        if (!notificationSettings.enabled || !workspaceHandle) return;\r\n\r\n        const check = async () => {\r\n            const currentNodes = nodesRef.current;\r\n\r\n            // Nodes from getNodes() don't have content ÔÇö load it here\r\n            const nodesWithContent = await Promise.all(\r\n                currentNodes.map(async (node) => {\r\n                    if (node.type !== 'file') return node;\r\n                    if (node.content !== undefined) return node;\r\n                    try {\r\n                        const content = await getFileContent(node.id);\r\n                        return { ...node, content };\r\n                    } catch (e) {\r\n                        console.warn('[Notifications] Failed to load content for', node.name, e);\r\n                        return node;\r\n                    }\r\n                })\r\n            );\r\n\r\n            const tasks = parseTasksFromNodes(nodesWithContent);\r\n            const settings = notificationSettingsRef.current;\r\n\r\n            // Run checkUpcomingTasks OUTSIDE setState to avoid React suppressing side-effects\r\n            setNotifiedTaskIds(prevNotifiedIds => {\r\n                const newIds = checkUpcomingTasks(tasks, settings, prevNotifiedIds);\r\n                if (newIds.length === 0) return prevNotifiedIds;\r\n                const next = new Set(prevNotifiedIds);\r\n                newIds.forEach(id => next.add(id));\r\n                return next;\r\n            });\r\n        };\r\n\r\n        const interval = setInterval(check, 60000);\r\n        check(); // Run immediately on enable\r\n\r\n        return () => clearInterval(interval);\r\n    }, [notificationSettings.enabled, workspaceHandle]);\r\n\r\n    const tree = buildTree(nodes);\r\n\r\n    const toggleFolder = (folderId) => {\r\n        setExpandedFolders(prev => {\r\n            const next = new Set(prev);\r\n            if (next.has(folderId)) next.delete(folderId);\r\n            else next.add(folderId);\r\n            return next;\r\n        });\r\n    };\r\n\r\n    const expandAll = () => setExpandedFolders(new Set(nodes.filter(n => n.type === 'folder').map(n => n.id)));\r\n    const collapseAll = () => setExpandedFolders(new Set());\r\n\r\n    const openAndExpandFile = (fileId) => {\r\n        const targetNode = nodes.find(n => n.id === fileId);\r\n        if (!targetNode) return;\r\n\r\n        setActiveFileId(fileId);\r\n        setLastInteractedNodeId(fileId);\r\n\r\n        let currentParentId = targetNode.parentId;\r\n        if (currentParentId) {\r\n            const parentsToExpand = [];\r\n            while (currentParentId) {\r\n                parentsToExpand.push(currentParentId);\r\n                const parentNode = nodes.find(n => n.id === currentParentId);\r\n                currentParentId = parentNode ? parentNode.parentId : null;\r\n            }\r\n\r\n            setExpandedFolders(prev => {\r\n                const next = new Set(prev);\r\n                parentsToExpand.forEach(id => next.add(id));\r\n                return next;\r\n            });\r\n        }\r\n    };\r\n\r\n    const addNode = async (name, type, parentId = null) => {\r\n        if (!workspaceHandle) return;\r\n        const safeName = name.replace(/[\\\\/:*?\"<>|]/g, '-').trim();\r\n        const extension = type === 'file' ? '.md' : '';\r\n        const idPath = parentId ? `${parentId}/${safeName}${extension}` : `${safeName}${extension}`;\r\n\r\n        let existingNode = nodes.find(n => n.id === idPath);\r\n        let finalIdPath = idPath;\r\n        let counter = 1;\r\n\r\n        while (existingNode) {\r\n            finalIdPath = `${idPath} (${counter})`;\r\n            existingNode = nodes.find(n => n.id === finalIdPath);\r\n            counter++;\r\n        }\r\n\r\n        const newNode = {\r\n            id: finalIdPath,\r\n            name: safeName,\r\n            type,\r\n            parentId,\r\n            ...(type === 'file' ? { content: '' } : {})\r\n        };\r\n\r\n        const previousNodes = nodes;\r\n        setNodes(prev => [...prev, newNode]);\r\n        if (type === 'file') setActiveFileId(newNode.id);\r\n        if (parentId && !expandedFolders.has(parentId)) {\r\n            setExpandedFolders(prev => new Set(prev).add(parentId));\r\n        }\r\n\r\n        try {\r\n            await createNode(newNode);\r\n            // We don't necessarily need to loadNodes() here if createNode \r\n            // successfully updates the backend-specific metadata (like gdriveId) \r\n            // in the local driver's internal state/cache. \r\n            // But for safety and to get formal IDs:\r\n            await loadNodes();\r\n        } catch (e) {\r\n            console.error(\"Failed to add node:\", e);\r\n            setNodes(previousNodes);\r\n            alert(\"Error: Could not create \" + type + \". Reverting changes.\");\r\n        }\r\n    };\r\n\r\n    const editNode = async (id, updates) => {\r\n        if (!workspaceHandle) return;\r\n        const oldNode = nodes.find(n => n.id === id);\r\n        if (!oldNode) return;\r\n\r\n        const previousNodes = nodes;\r\n        const previousActiveFileId = activeFileId;\r\n        const previousLastInteractedNodeId = lastInteractedNodeId;\r\n\r\n        // Optimistically update\r\n        setNodes(prev => prev.map(n => {\r\n            if (n.id !== id) return n;\r\n            const updated = { ...n, ...updates };\r\n            // Note: if name changed, id should probably change too for local logic\r\n            // but the current architecture uses path as ID. \r\n            // If the name changed, we'll wait for the backend's result to get the new formal path ID.\r\n            return updated;\r\n        }));\r\n\r\n        try {\r\n            const updatedNode = await updateNode(id, updates, oldNode);\r\n            if (updatedNode && updatedNode.id !== id) {\r\n                if (activeFileId === id) setActiveFileId(updatedNode.id);\r\n                if (lastInteractedNodeId === id) setLastInteractedNodeId(updatedNode.id);\r\n            }\r\n            await loadNodes();\r\n        } catch (e) {\r\n            console.error(\"Failed to edit node:\", e);\r\n            setNodes(previousNodes);\r\n            setActiveFileId(previousActiveFileId);\r\n            setLastInteractedNodeId(previousLastInteractedNodeId);\r\n            alert(\"Error: Could not update item. Reverting changes.\");\r\n        }\r\n    };\r\n\r\n    const removeNode = async (id) => {\r\n        if (!workspaceHandle) return;\r\n        const node = nodes.find(n => n.id === id);\r\n        if (!node) return;\r\n\r\n        const previousNodes = nodes;\r\n        setNodes(prev => prev.filter(n => n.id !== id));\r\n        if (activeFileId === id) setActiveFileId(null);\r\n        if (lastInteractedNodeId === id) setLastInteractedNodeId(null);\r\n\r\n        try {\r\n            await deleteNode(id, node.type);\r\n            await loadNodes();\r\n        } catch (e) {\r\n            console.error(\"Failed to remove node:\", e);\r\n            setNodes(previousNodes);\r\n            alert(\"Error: Could not delete item. Reverting changes.\");\r\n        }\r\n    };\r\n\r\n    const ensureAllContentsLoaded = async () => {\r\n        const filesToLoad = nodes.filter(n => n.type === 'file' && n.content === undefined);\r\n        if (filesToLoad.length === 0) return;\r\n\r\n\r\n\r\n        // Load all missing contents\r\n        const updatedNodes = await Promise.all(nodes.map(async (node) => {\r\n            if (node.type === 'file' && node.content === undefined) {\r\n                try {\r\n                    const content = await getFileContent(node.id);\r\n                    return { ...node, content };\r\n                } catch (e) {\r\n                    console.error(`Failed to load content for ${node.id}:`, e);\r\n                    return node;\r\n                }\r\n            }\r\n            return node;\r\n        }));\r\n\r\n        setNodes(updatedNodes);\r\n    };\r\n\r\n    const value = {\r\n        nodes, tree, activeFileId, setActiveFileId, expandedFolders, toggleFolder, expandAll, collapseAll, openAndExpandFile,\r\n        addNode, editNode, removeNode, getFileContent, ensureAllContentsLoaded, isInitializing, workspaceHandle, storageMode, selectWorkspace, disconnectWorkspace,\r\n        needsPermission, grantLocalPermission, globalAddingState, setGlobalAddingState, lastInteractedNodeId, setLastInteractedNodeId,\r\n        installApp,\r\n        isInstallable: !isPwaInstalled && !window.matchMedia('(display-mode: standalone)').matches && (!window.navigator.standalone),\r\n        showInstallModal, setShowInstallModal,\r\n        notificationSettings, setNotificationSettings,\r\n        isDarkMode, setIsDarkMode\r\n    };\r\n\r\n    return <NotesContext.Provider value={value}>{children}</NotesContext.Provider>;\r\n};\r\n\r\nexport const useNotes = () => {\r\n    const context = useContext(NotesContext);\r\n    if (!context) throw new Error('useNotes must be used within a NotesProvider');\r\n    return context;\r\n};","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jonat\\Downloads\\redly\\src\\lib\\db.js","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'options' is assigned a value but never used.","line":7,"column":43,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":50,"suggestions":[{"messageId":"removeVar","data":{"varName":"options"},"fix":{"range":[207,221],"text":""},"desc":"Remove unused variable 'options'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'e' is defined but never used.","line":133,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":133,"endColumn":15}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { setHandle, getHandle, clearHandles } from './idb_store';\r\nimport * as localDriver from './local_driver';\r\n\r\nexport { getHandle };\r\nlet currentMode = null;\r\n\r\nexport const initWorkspace = async (mode, options = {}) => {\r\n  try {\r\n    currentMode = mode;\r\n    if (mode === 'sandbox') {\r\n      const handle = await navigator.storage.getDirectory();\r\n      localDriver.setRootHandle(handle);\r\n      await setHandle('workspace_mode', 'sandbox');\r\n    } else if (mode === 'local') {\r\n      const handle = await window.showDirectoryPicker({ mode: 'readwrite' });\r\n      localDriver.setRootHandle(handle);\r\n      await setHandle('workspace_mode', 'local');\r\n      await setHandle('local_root', handle);\r\n    }\r\n    return true;\r\n  } catch (err) {\r\n    console.error('Initialisation failed:', err);\r\n    throw err;\r\n  }\r\n};\r\n\r\nexport const loadSavedWorkspace = async () => {\r\n  const mode = await getHandle('workspace_mode');\r\n  currentMode = mode;\r\n  if (mode === 'sandbox') {\r\n    localDriver.setRootHandle(await navigator.storage.getDirectory());\r\n    return true;\r\n  } else if (mode === 'local') {\r\n    const handle = await getHandle('local_root');\r\n    if (handle) {\r\n      const perm = await handle.queryPermission({ mode: 'readwrite' });\r\n      if (perm === 'granted') {\r\n        localDriver.setRootHandle(handle);\r\n        return true;\r\n      } else {\r\n        return 'requires_permission';\r\n      }\r\n    }\r\n  }\r\n  return false;\r\n};\r\n\r\nexport const requestLocalPermission = async () => {\r\n  const handle = await getHandle('local_root');\r\n  if (handle && (await handle.requestPermission({ mode: 'readwrite' })) === 'granted') {\r\n    localDriver.setRootHandle(handle);\r\n    return true;\r\n  }\r\n  return false;\r\n};\r\n\r\nexport const clearWorkspaceHandle = async () => {\r\n  await clearHandles();\r\n  currentMode = null;\r\n};\r\n\r\nexport const getNodes = async () => {\r\n  return localDriver.getNodes();\r\n};\r\n\r\nexport const getFileContent = async (id) => {\r\n  return localDriver.getFileContent(id);\r\n};\r\n\r\nexport const createNode = async (node) => {\r\n  return localDriver.createNode(node);\r\n};\r\n\r\nexport const updateNode = async (id, updates, oldNode) => {\r\n  return localDriver.updateNode(id, updates, oldNode);\r\n};\r\n\r\nexport const deleteNode = async (id, type) => {\r\n  return localDriver.deleteNode(id, type);\r\n};\r\n\r\nexport const buildTree = (nodes) => {\r\n  const map = new Map();\r\n  const roots = [];\r\n  nodes.forEach(node => map.set(node.id, { ...node, children: [] }));\r\n  nodes.forEach(node => {\r\n    const mappedNode = map.get(node.id);\r\n    if (node.parentId && map.has(node.parentId)) {\r\n      map.get(node.parentId).children.push(mappedNode);\r\n    } else {\r\n      roots.push(mappedNode);\r\n    }\r\n  });\r\n\r\n  const sortNodes = (nodeList) => {\r\n    nodeList.sort((a, b) => {\r\n      if (a.type !== b.type) return a.type === 'folder' ? -1 : 1;\r\n      return a.name.localeCompare(b.name);\r\n    });\r\n    nodeList.forEach(n => { if (n.children.length > 0) sortNodes(n.children); });\r\n  };\r\n  sortNodes(roots);\r\n  return roots;\r\n};\r\n\r\n// Backup and Restore for Sandbox\r\nexport const exportSandboxData = async () => {\r\n  if (currentMode !== 'sandbox') throw new Error('Export only supported for Sandbox storage');\r\n  const nodes = await localDriver.getNodes();\r\n  const fullNodes = await Promise.all(nodes.map(async node => {\r\n    if (node.type === 'file') {\r\n      const content = await localDriver.getFileContent(node.id);\r\n      return { ...node, content };\r\n    }\r\n    return node;\r\n  }));\r\n  return {\r\n    version: '1.0',\r\n    timestamp: new Date().toISOString(),\r\n    nodes: fullNodes\r\n  };\r\n};\r\n\r\nexport const importSandboxData = async (backup) => {\r\n  if (currentMode !== 'sandbox') throw new Error('Import only supported for Sandbox storage');\r\n  if (!backup || !backup.nodes) throw new Error('Invalid backup format');\r\n\r\n  // Clear existing sandbox\r\n  const nodes = await localDriver.getNodes();\r\n  for (const node of nodes) {\r\n    try {\r\n      await localDriver.deleteNode(node.id, node.type);\r\n    } catch (e) {\r\n      console.warn('Failed to delete node during import cleanup:', node.id);\r\n    }\r\n  }\r\n\r\n  // Restore from backup\r\n  // Sort by ID depth to ensure folders are created before files\r\n  const sortedNodes = [...backup.nodes].sort((a, b) => a.id.split('/').length - b.id.split('/').length);\r\n\r\n  for (const node of sortedNodes) {\r\n    await localDriver.createNode(node);\r\n  }\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jonat\\Downloads\\redly\\src\\lib\\idb_store.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jonat\\Downloads\\redly\\src\\lib\\local_driver.js","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'oldPath' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":171,"column":23,"nodeType":"Identifier","messageId":"unusedVar","endLine":171,"endColumn":30,"suggestions":[{"messageId":"removeVar","data":{"varName":"oldPath"},"fix":{"range":[7728,7755],"text":""},"desc":"Remove unused variable 'oldPath'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'type' is defined but never used.","line":188,"column":38,"nodeType":"Identifier","messageId":"unusedVar","endLine":188,"endColumn":42,"suggestions":[{"messageId":"removeVar","data":{"varName":"type"},"fix":{"range":[8299,8305],"text":""},"desc":"Remove unused variable 'type'."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// --- Driver for OPFS and Native File System API ---\r\n\r\nlet currentRootHandle = null;\r\nlet operationLock = Promise.resolve();\r\n\r\nasync function withLock(fn) {\r\n    const next = operationLock.then(fn);\r\n    operationLock = next.catch(() => { });\r\n    return next;\r\n}\r\n\r\nasync function withRetry(fn, retries = 3, delay = 50) {\r\n    for (let i = 0; i < retries; i++) {\r\n        try {\r\n            return await fn();\r\n        } catch (err) {\r\n            const isStateError = err.message?.includes('state had changed') || err.name === 'ModificationError';\r\n            if (isStateError && i < retries - 1) {\r\n                console.warn(`[local_driver] Operation failed (state changed), retrying ${i + 1}/${retries}...`);\r\n                await new Promise(r => setTimeout(r, delay));\r\n                continue;\r\n            }\r\n            throw err;\r\n        }\r\n    }\r\n}\r\n\r\nexport const setRootHandle = (handle) => { currentRootHandle = handle; };\r\n\r\nexport const getDirHandleFromPath = async (path, create = false) => {\r\n    if (!path) return currentRootHandle;\r\n    const parts = path.split('/');\r\n    let handle = currentRootHandle;\r\n    for (const part of parts) {\r\n        handle = await handle.getDirectoryHandle(part, { create });\r\n    }\r\n    return handle;\r\n};\r\n\r\nexport const getNodes = async (dirHandle = currentRootHandle, currentPath = '') => {\r\n    if (!dirHandle) return [];\r\n    const nodes = [];\r\n    try {\r\n        for await (const entry of dirHandle.values()) {\r\n            const nodePath = currentPath ? `${currentPath}/${entry.name}` : entry.name;\r\n\r\n            if (entry.kind === 'file' && entry.name.endsWith('.md')) {\r\n                const file = await entry.getFile();\r\n                nodes.push({\r\n                    id: nodePath,\r\n                    name: entry.name.replace('.md', ''),\r\n                    type: 'file',\r\n                    parentId: currentPath || null,\r\n                    updatedAt: file.lastModified\r\n                });\r\n            } else if (entry.kind === 'directory' && !entry.name.startsWith('.')) {\r\n                nodes.push({ id: nodePath, name: entry.name, type: 'folder', parentId: currentPath || null });\r\n                const children = await getNodes(entry, nodePath);\r\n                nodes.push(...children);\r\n            }\r\n        }\r\n    } catch (err) {\r\n        console.error('Failed to get nodes:', err);\r\n    }\r\n    return nodes;\r\n};\r\n\r\nexport const getFileContent = async (id) => {\r\n    return withLock(() => withRetry(async () => {\r\n        const parts = id.split('/');\r\n        const fileName = parts.pop();\r\n        const parentPath = parts.join('/');\r\n        const parentHandle = await getDirHandleFromPath(parentPath);\r\n        const fileHandle = await parentHandle.getFileHandle(fileName);\r\n        const file = await fileHandle.getFile();\r\n        return await file.text();\r\n    }));\r\n};\r\n\r\nexport const createNode = async (node) => {\r\n    return withLock(() => withRetry(async () => {\r\n        const parentHandle = await getDirHandleFromPath(node.parentId, true);\r\n        if (node.type === 'folder') {\r\n            await parentHandle.getDirectoryHandle(node.name, { create: true });\r\n        } else {\r\n            const fileHandle = await parentHandle.getFileHandle(`${node.name}.md`, { create: true });\r\n            const writable = await fileHandle.createWritable();\r\n            await writable.write(node.content || '');\r\n            await writable.close();\r\n        }\r\n        return node;\r\n    }));\r\n};\r\n\r\n// Helper for recursive folder copy (fallback when .move() is unavailable)\r\nasync function copyFolderContents(sourceHandle, targetHandle) {\r\n    for await (const entry of sourceHandle.values()) {\r\n        if (entry.kind === 'file') {\r\n            const file = await entry.getFile();\r\n            const newFileHandle = await targetHandle.getFileHandle(entry.name, { create: true });\r\n            const writable = await newFileHandle.createWritable();\r\n            await writable.write(await file.arrayBuffer());\r\n            await writable.close();\r\n        } else if (entry.kind === 'directory') {\r\n            const newFolderHandle = await targetHandle.getDirectoryHandle(entry.name, { create: true });\r\n            await copyFolderContents(entry, newFolderHandle);\r\n        }\r\n    }\r\n}\r\n\r\nexport const updateNode = async (id, updates, oldNode) => {\r\n    return withLock(() => withRetry(async () => {\r\n        const parentHandle = await getDirHandleFromPath(oldNode.parentId);\r\n        let currentHandle = oldNode.type === 'file'\r\n            ? await parentHandle.getFileHandle(`${oldNode.name}.md`)\r\n            : await parentHandle.getDirectoryHandle(oldNode.name);\r\n\r\n        let finalNode = { ...oldNode, ...updates };\r\n\r\n        // 1. Handle Renaming or Moving (Storage Level)\r\n        if ((updates.name && updates.name !== oldNode.name) || (updates.parentId !== undefined && updates.parentId !== oldNode.parentId)) {\r\n            const newName = updates.name || oldNode.name;\r\n            const newParentId = updates.parentId !== undefined ? updates.parentId : oldNode.parentId;\r\n            const newParentHandle = await getDirHandleFromPath(newParentId, true);\r\n            const fileName = oldNode.type === 'file' ? `${newName}.md` : newName;\r\n\r\n            let moveSuccessful = false;\r\n            if (currentHandle.move) {\r\n                try {\r\n                    await currentHandle.move(newParentHandle, fileName);\r\n                    // After move, we need to update the handle reference if we want to write content later\r\n                    currentHandle = oldNode.type === 'file'\r\n                        ? await newParentHandle.getFileHandle(fileName)\r\n                        : await newParentHandle.getDirectoryHandle(newName);\r\n                    moveSuccessful = true;\r\n                } catch (moveErr) {\r\n                    console.warn('Native move failed, falling back to copy/delete:', moveErr);\r\n                }\r\n            }\r\n\r\n            if (!moveSuccessful) {\r\n                // Fallback: Copy and Delete\r\n                if (oldNode.type === 'file') {\r\n                    const file = await currentHandle.getFile();\r\n                    const content = updates.content !== undefined ? updates.content : await file.text();\r\n                    const newFileHandle = await newParentHandle.getFileHandle(fileName, { create: true });\r\n                    const writable = await newFileHandle.createWritable();\r\n                    await writable.write(content);\r\n                    await writable.close();\r\n\r\n                    // Ensure we use the correct filename including extension for removal\r\n                    const oldFileName = oldNode.type === 'file' ? `${oldNode.name}.md` : oldNode.name;\r\n                    await parentHandle.removeEntry(oldFileName, { recursive: oldNode.type === 'folder' });\r\n                    currentHandle = newFileHandle;\r\n                    // Mark content as handled so we don't write it again below\r\n                    updates.content = undefined;\r\n                } else {\r\n                    const newFolderHandle = await newParentHandle.getDirectoryHandle(newName, { create: true });\r\n                    await copyFolderContents(currentHandle, newFolderHandle);\r\n                    await parentHandle.removeEntry(oldNode.name, { recursive: true });\r\n                    currentHandle = newFolderHandle;\r\n                }\r\n            }\r\n\r\n\r\n            // Update ID\r\n            if (oldNode.type === 'file') {\r\n                finalNode.id = newParentId ? `${newParentId}/${fileName}` : fileName;\r\n            } else {\r\n                // For folders, we need to be careful with ID replacement if it's a nested path\r\n                const oldPath = oldNode.id;\r\n                const parentPath = oldNode.parentId || '';\r\n                finalNode.id = parentPath ? `${parentPath}/${newName}` : newName;\r\n            }\r\n        }\r\n\r\n        // 2. Handle Content Updates (File only)\r\n        if (oldNode.type === 'file' && updates.content !== undefined) {\r\n            const writable = await currentHandle.createWritable();\r\n            await writable.write(updates.content);\r\n            await writable.close();\r\n        }\r\n\r\n        return finalNode;\r\n    }));\r\n};\r\n\r\nexport const deleteNode = async (id, type) => {\r\n    return withLock(() => withRetry(async () => {\r\n        const name = id.split('/').pop();\r\n        const parentId = id.substring(0, id.lastIndexOf('/')) || null;\r\n        const parentHandle = await getDirHandleFromPath(parentId);\r\n        // name already includes .md for files because id is nodePath which is entry.name\r\n        await parentHandle.removeEntry(name, { recursive: true });\r\n    }));\r\n};\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jonat\\Downloads\\redly\\src\\main.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jonat\\Downloads\\redly\\src\\utils\\dateHelpers.js","messages":[{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\/.","line":90,"column":69,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":90,"endColumn":70,"suggestions":[{"messageId":"removeEscape","fix":{"range":[3536,3537],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[3536,3536],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\-.","line":90,"column":71,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":90,"endColumn":72,"suggestions":[{"messageId":"removeEscape","fix":{"range":[3538,3539],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[3538,3538],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\/.","line":90,"column":87,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":90,"endColumn":88,"suggestions":[{"messageId":"removeEscape","fix":{"range":[3554,3555],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[3554,3554],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\-.","line":90,"column":89,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":90,"endColumn":90,"suggestions":[{"messageId":"removeEscape","fix":{"range":[3556,3557],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[3556,3556],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"export const getDateColor = (dateObj, hasTime = false) => {\r\n    if (!dateObj) return 'var(--danger-color)';\r\n\r\n    const now = new Date();\r\n    const target = new Date(dateObj);\r\n\r\n    // Get strictly local Y-M-D for \"is it today\" check\r\n    const nowLocalStr = `${now.getFullYear()}-${now.getMonth() + 1}-${now.getDate()}`;\r\n    const targetLocalStr = `${target.getFullYear()}-${target.getMonth() + 1}-${target.getDate()}`;\r\n    const isToday = nowLocalStr === targetLocalStr;\r\n\r\n    if (hasTime) {\r\n        // If it's today and the specific time hasn't passed yet, it's \"Today\" (Amber)\r\n        // If the specific time has passed today, it's \"Overdue\" (Red)\r\n        if (target.getTime() < now.getTime()) {\r\n            return 'var(--color-overdue)';\r\n        }\r\n        if (isToday) return 'var(--color-today)';\r\n        return 'var(--color-future)';\r\n    } else {\r\n        // Pure day comparison\r\n        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());\r\n        const targetDay = new Date(target.getFullYear(), target.getMonth(), target.getDate());\r\n\r\n        const diffTime = targetDay.getTime() - today.getTime();\r\n        const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24));\r\n\r\n        if (diffDays < 0) return 'var(--color-overdue)'; // Overdue\r\n        if (diffDays === 0) return 'var(--color-today)'; // Today\r\n        return 'var(--color-future)'; // Future\r\n    }\r\n};\r\n\r\nexport const parseDateString = (input) => {\r\n    if (!input || !input.trim()) return { parsedDate: '', hasDate: false, hasTime: false };\r\n\r\n    let hasDate = false;\r\n    let hasTime = false;\r\n    let dateObj = new Date(); // default to today for relative times\r\n\r\n    const str = input.trim().toLowerCase();\r\n\r\n    // Extract time (e.g. 5pm, 15:30)\r\n    let timeRegex = /\\b(\\d{1,2})(?::(\\d{2}))?\\s*(am|pm)\\b/i;\r\n    let hours = 0;\r\n    let minutes = 0;\r\n\r\n    let timeMatch = str.match(timeRegex);\r\n    let dateStrWithoutTime = str;\r\n\r\n    if (timeMatch) {\r\n        hasTime = true;\r\n        hours = parseInt(timeMatch[1], 10);\r\n        minutes = timeMatch[2] ? parseInt(timeMatch[2], 10) : 0;\r\n        const ampm = timeMatch[3];\r\n\r\n        if (ampm === 'pm' && hours < 12) hours += 12;\r\n        if (ampm === 'am' && hours === 12) hours = 0;\r\n\r\n        dateStrWithoutTime = str.replace(timeMatch[0], '').trim();\r\n    } else {\r\n        const fallbackRegex = /\\b(\\d{1,2}):(\\d{2})\\b/;\r\n        const m = str.match(fallbackRegex);\r\n        if (m) {\r\n            hasTime = true;\r\n            hours = parseInt(m[1], 10);\r\n            minutes = parseInt(m[2], 10);\r\n            dateStrWithoutTime = str.replace(m[0], '').trim();\r\n        }\r\n    }\r\n\r\n    if (!dateStrWithoutTime) {\r\n        // if it was only time, like \"5pm\", assume today\r\n        hasDate = true;\r\n    } else if (dateStrWithoutTime.includes('today')) {\r\n        hasDate = true;\r\n    } else if (dateStrWithoutTime.includes('tomorrow')) {\r\n        dateObj.setDate(dateObj.getDate() + 1);\r\n        hasDate = true;\r\n    } else {\r\n        // ISO format: YYYY-MM-DD (from stored data-date attributes on reload)\r\n        const isoMatch = dateStrWithoutTime.match(/\\b(\\d{4})-(\\d{2})-(\\d{2})\\b/);\r\n        if (isoMatch) {\r\n            hasDate = true;\r\n            dateObj.setFullYear(parseInt(isoMatch[1], 10));\r\n            dateObj.setMonth(parseInt(isoMatch[2], 10) - 1);\r\n            dateObj.setDate(parseInt(isoMatch[3], 10));\r\n        } else {\r\n            // DD/MM or DD/MM/YYYY or DD/MM/YY\r\n            const dateMatch = dateStrWithoutTime.match(/\\b(\\d{1,2})[\\/\\-](\\d{1,2})(?:[\\/\\-](\\d{2,4}))?\\b/);\r\n            if (dateMatch) {\r\n                hasDate = true;\r\n                const dStr = parseInt(dateMatch[1], 10);\r\n                const mStr = parseInt(dateMatch[2], 10) - 1;\r\n                dateObj.setMonth(mStr);\r\n                dateObj.setDate(dStr);\r\n                if (dateMatch[3]) {\r\n                    let y = parseInt(dateMatch[3], 10);\r\n                    if (y < 100) y += 2000;\r\n                    dateObj.setFullYear(y);\r\n                }\r\n            } else {\r\n                // Days of week\r\n                const days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];\r\n                let nextIndex = -1;\r\n                for (let i = 0; i < days.length; i++) {\r\n                    if (dateStrWithoutTime.includes(days[i])) {\r\n                        nextIndex = i;\r\n                        break;\r\n                    }\r\n                }\r\n                if (nextIndex !== -1) {\r\n                    hasDate = true;\r\n                    const isNext = dateStrWithoutTime.includes('next');\r\n                    let dayDiff = nextIndex - dateObj.getDay();\r\n                    if (dayDiff <= 0) dayDiff += 7; // Always jump to future\r\n                    if (isNext) dayDiff += 7; // jump to week after\r\n                    dateObj.setDate(dateObj.getDate() + dayDiff);\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    if (!hasDate) {\r\n        return { parsedDate: '', hasDate: false, hasTime: false };\r\n    }\r\n\r\n    const y = dateObj.getFullYear();\r\n    const m = String(dateObj.getMonth() + 1).padStart(2, '0');\r\n    const d = String(dateObj.getDate()).padStart(2, '0');\r\n    let parsedDate = `${y}-${m}-${d}`;\r\n\r\n    if (hasTime) {\r\n        const hh = String(hours).padStart(2, '0');\r\n        const mm = String(minutes).padStart(2, '0');\r\n        parsedDate += `T${hh}:${mm}`;\r\n    }\r\n\r\n    return { parsedDate, hasDate, hasTime };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jonat\\Downloads\\redly\\src\\utils\\notificationManager.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jonat\\Downloads\\redly\\src\\utils\\taskParser.js","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'e' is defined but never used.","line":57,"column":30,"nodeType":"Identifier","messageId":"unusedVar","endLine":57,"endColumn":31},{"ruleId":"no-empty","severity":2,"message":"Empty block statement.","line":57,"column":33,"nodeType":"BlockStatement","messageId":"unexpected","endLine":57,"endColumn":36,"suggestions":[{"messageId":"suggestComment","data":{"type":"block"},"fix":{"range":[2163,2164],"text":" /* empty */ "},"desc":"Add comment inside empty block statement."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\-.","line":62,"column":56,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":62,"endColumn":57,"suggestions":[{"messageId":"removeEscape","fix":{"range":[2399,2400],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[2399,2399],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\-.","line":79,"column":59,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":79,"endColumn":60,"suggestions":[{"messageId":"removeEscape","fix":{"range":[3080,3081],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[3080,3080],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Parses all tasks from the given nodes.\r\n * Expects nodes to have Markdown content.\r\n */\r\nexport function parseTasksFromNodes(nodes) {\r\n    const tasks = [];\r\n\r\n    // Helper to resolve breadcrumb path for a node\r\n    const getPath = (nodeId) => {\r\n        const path = [];\r\n        let currentId = nodeId;\r\n        while (currentId) {\r\n            const current = nodes.find(n => n.id === currentId);\r\n            if (current) {\r\n                path.unshift(current.name);\r\n                currentId = current.parentId;\r\n            } else {\r\n                break;\r\n            }\r\n        }\r\n        return path;\r\n    };\r\n\r\n    const files = nodes.filter(n => n.type === 'file' && n.content);\r\n\r\n    files.forEach(file => {\r\n        const breadcrumbPath = getPath(file.id);\r\n        const lines = file.content.split('\\n');\r\n\r\n        // Regex to match GFM task list items: \"- [ ] text\" or \"- [x] text\"\r\n        const taskRegex = /^\\s*-\\s*\\[([ xX])\\]\\s*(.*)$/;\r\n\r\n        lines.forEach((line, lineIndex) => {\r\n            const match = line.match(taskRegex);\r\n            if (match) {\r\n                const isChecked = match[1].toLowerCase() === 'x';\r\n                let text = match[2].trim();\r\n\r\n                // Advanced date/time extraction\r\n                // Patterns: @YYYY-MM-DD or @YYYY-MM-DD HH:MM\r\n                let date = null;\r\n                let hasTime = false;\r\n\r\n                // Matches @2023-10-27 or @2023-10-27 15:30\r\n                const dateRegex = /@(\\d{4}-\\d{2}-\\d{2}(?:\\s+\\d{2}:\\d{2})?)/;\r\n                const dateMatch = text.match(dateRegex);\r\n                if (dateMatch) {\r\n                    const dateStr = dateMatch[1].replace(' ', 'T');\r\n                    try {\r\n                        const d = new Date(dateStr);\r\n                        if (!isNaN(d.getTime())) {\r\n                            date = d;\r\n                            hasTime = dateMatch[1].includes(':');\r\n                            // Remove the date string from the text to avoid duplication in UI\r\n                            text = text.replace(dateRegex, '').trim();\r\n                        }\r\n                    } catch (e) { }\r\n                }\r\n\r\n                // Kanban Column Extraction & Tags (Hashtags)\r\n                let column = isChecked ? 'done' : 'todo'; // default columns based on state\r\n                const tagRegex = /(?:^|\\s)#([a-zA-Z0-9_\\-]+)/g;\r\n                let tagMatch;\r\n                let lastTagMatch = null;\r\n                const tags = [];\r\n\r\n                // Find all hashtags in the string\r\n                while ((tagMatch = tagRegex.exec(text)) !== null) {\r\n                    const tag = tagMatch[1].toLowerCase();\r\n                    if (!tags.includes(tag)) tags.push(tag);\r\n                    lastTagMatch = tagMatch;\r\n                }\r\n\r\n                if (lastTagMatch) {\r\n                    column = lastTagMatch[1].toLowerCase();\r\n                }\r\n\r\n                // Remove all tags from the display text to keep UI clean\r\n                text = text.replace(/(?:^|\\s)#([a-zA-Z0-9_\\-]+)/g, '').trim();\r\n\r\n                tasks.push({\r\n                    // Stable ID based on file path and line index\r\n                    id: `${file.id}:L${lineIndex}`,\r\n                    fileId: file.id,\r\n                    lineIndex: lineIndex,\r\n                    path: breadcrumbPath,\r\n                    checked: isChecked,\r\n                    text: text,\r\n                    date: date,\r\n                    hasTime: hasTime,\r\n                    column: column,\r\n                    tags: tags\r\n                });\r\n            }\r\n        });\r\n    });\r\n\r\n    return tasks;\r\n}\r\n","usedDeprecatedRules":[]}]
